# Backend Development Guidelines

## Go Development

### Standard Patterns

**Reflection**:
- Always use reflect.Pointer instead of reflect.Ptr
- Always use reflect.TypeFor[T]() instead of reflect.TypeOf() when the type is known at compile time.

**Logging**:
- Use context-aware slog methods: `slog.InfoContext()`, `slog.ErrorContext()`, etc.
- Error fields should use `"err"` not `"error"`.

**Testing**:
- Use table-driven tests.
- Store tests in `*_test.go` files next to implementation.
- Target 95% coverage.
- Use subtest. Create TestFoo then for each method create a subtest.
- In unit tests, use t.Context(), never context.Background().

### HTTP handlers

**Errors**: Use `errors.NewAPIError(statusCode, code, message)` from internal/errors for HTTP errors. Implement `ErrorWithStatus` interface.

**Handler Signature**: All HTTP handlers wrapped with `Wrap()` must have signature:
```go
func(context.Context, RequestType) (*ResponseType, error)
```

## API Development

### Type Generation (Single Source of Truth)

mddb uses [tygo](https://github.com/gzuidhof/tygo) to generate TypeScript interfaces from Go structs. This ensures the frontend and backend stay in sync automatically.

- **Source of Truth**: All Request, Response, and DTO structs MUST be defined in `internal/models/` (typically in `api.go`).
- **Encapsulation**: Structs in `internal/storage/` and `internal/server/handlers/` are internal implementation details and are NOT exported to the frontend.
- **Generated File**: `sdk/types.gen.ts` (DO NOT EDIT MANUALLY).
- **Command**: `make types` (included in `make build`).

When you add or modify an API endpoint, add the Request/Response structs to `internal/models/api.go`, then run `make types` to update the frontend.

### Endpoint Conventions

- **HTTP Methods**: Use only GET and POST. No PUT or DELETE.
  - GET for reads
  - POST for creates, updates, and deletes (use `/delete` suffix for destructive actions)
- **Response format**: Always JSON
- **Error responses**: Include `error` field with structured details (code, message)
- **Success responses**: Include `data` field with result (except for list endpoints which may return array directly under key like `nodes`)

## File Operations

### Markdown Handling (Pages)

- Front matter (YAML) for metadata
- UTF-8 encoding always
- Normalize line endings (LF)

### Database Storage Format (jsonldb)

The `internal/jsonldb` package provides a generic, concurrent-safe, JSONL-backed data store.

#### JSONL Table Format

Tables are stored as `.jsonl` files with:
- **Line 1**: Schema header (JSON object with `version` and `columns`)
- **Lines 2+**: Data rows (one JSON object per line)

Example `data.jsonl`:
```jsonl
{"version":"1","columns":[{"name":"id","type":"id"},{"name":"title","type":"string"}]}
{"id":"01JWAB...","title":"First row"}
{"id":"01JWAC...","title":"Second row"}
```

**Row Requirements:**
- Must implement `Row[T]` interface: `Clone()`, `GetID()`, `Validate()`
- IDs are 64-bit integers encoded as base32 hex strings (0-9A-V, time-sortable, case-insensitive safe)
- Rows are kept sorted by ID on disk

#### Blob Storage Format

Large binary data is stored separately from JSONL rows:
- **Location**: Sibling directory with `.blobs` suffix (e.g., `data.jsonl` â†’ `data.blobs/`)
- **Structure**: 256-way fan-out by first 2 chars of hash (e.g., `data.blobs/SE/OC8G...`)
- **Reference Format**: `sha256:<BASE32HEX>-<size>` (52 uppercase base32 hex chars (0-9A-V) + decimal size)
- **Content-Addressed**: Identical content shares the same file (deduplication)
- **Garbage Collection**: Orphaned blobs are removed on table load

Example blob ref: `sha256:SEOC8GKOVGE196NRUJ49IRTP4GJQSGF4CIDP6J54IMCHMU2IN1AG-0`

**Using Blobs in Rows:**
```go
type MyRow struct {
    ID      jsonldb.ID
    Content jsonldb.Blob  // Automatically discovered via reflection
}

// Creating a blob:
writer, _ := table.NewBlob()
writer.Write(data)
blob, _ := writer.Close()
row.Content = blob
table.Append(&row)

// Reading a blob:
reader, _ := row.Content.Reader()
io.Copy(dst, reader)
reader.Close()
```

Blob fields are discovered automatically via reflection, including nested structs and slices.

#### Column Types

- `id` - Row identifier (required, unique)
- `string` - Text
- `int`, `float` - Numbers
- `bool` - Boolean
- `time` - Timestamp
- `blob_ref` - Reference to external blob file

## Build & Test

Run these commands to verify changes:
- `make lint` - Run linters
- `make build` - Compile backend and frontend
- `make test` - Run all tests

## Code Quality & Linting

**All code must pass `make lint` before commits.**

### Go Backend (golangci-lint)

Configured in `.golangci.yml`. Enforces error handling (`errcheck`, `errorlint`), naming (`errname`), style (`revive`, `gocritic`), and more.

Run with:
```bash
make lint
make lint-fix
```

<!-- BEGIN FILE INDEX -->
## File Index

Autogenerated file index based on first-line comments.

- `backend.go`: Package backend is the root module for mddb, a local-first markdown database
- `cmd/mddb/main.go`: Package main is the entry point for the mddb server.
- `cmd/notion-import/main.go`: Package main is the entry point for the notion-import CLI tool.
- `docs/PLAN.md`: Backend Implementation Plan
- `docs/REQUIREMENTS.md`: Backend Requirements
- `docs/ultimate-guide-to-multi-tenant-saas-data-modeling.md`: Ultimate Guide to Multi-Tenant SaaS Data Modeling
- `frontend/frontend.go`: Package frontend embeds the compiled SolidJS web UI assets.
- `internal/apiclient/main.go`: Command apiclient generates a TypeScript API client from router.go and handler signatures.
- `internal/apiroutes/main.go`: Command apiroutes extracts API routes from router.go and generates sdk/API.md.
- `internal/email/email.go`: Package email provides SMTP email sending functionality.
- `internal/email/templates.go`: Provides localized email templates.
- `internal/jsonldb/blob.go`: Defines the Blob type and content-addressed reference format.
- `internal/jsonldb/blobstore.go`: Manages the on-disk storage layout for content-addressed blobs.
- `internal/jsonldb/columns.go`: Handles schema definition, column types, and reflection-based schema generation.
- `internal/jsonldb/doc.go`: Package jsonldb provides a generic, concurrent-safe, JSONL-backed data store.
- `internal/jsonldb/id.go`: Implements a k-sortable, 64-bit unique identifier generator.
- `internal/jsonldb/index.go`: Provides concurrent-safe, in-memory secondary indexes for tables.
- `internal/jsonldb/table.go`: Implements the concurrent-safe Table[T] for JSONL storage.
- `internal/notion/assets.go`: Downloads and stores assets from Notion (images, files, etc).
- `internal/notion/assets_test.go`: Tests for asset downloading and path generation.
- `internal/notion/client.go`: Implements the Notion API client with rate limiting.
- `internal/notion/doc.go`: Package notion provides a client and extractor for the Notion API.
- `internal/notion/extractor.go`: Orchestrates extraction of Notion workspace data.
- `internal/notion/manifest.go`: Parses view manifest YAML files for import.
- `internal/notion/manifest_test.go`: Tests for view manifest parsing.
- `internal/notion/mapper.go`: Maps Notion types to mddb types.
- `internal/notion/mapper_test.go`: Tests for the Notion to mddb type mapper.
- `internal/notion/markdown.go`: Converts Notion blocks to Markdown.
- `internal/notion/markdown_test.go`: Tests for the Notion block to Markdown converter.
- `internal/notion/progress.go`: Defines progress reporting interfaces and implementations.
- `internal/notion/types.go`: Defines Notion API response types.
- `internal/notion/writer.go`: Writes extracted Notion data to mddb storage format.
- `internal/server/bandwidth/limiter.go`: Package bandwidth provides bandwidth rate limiting for egress traffic.
- `internal/server/bandwidth/limiter_test.go`: Package bandwidth provides bandwidth rate limiting for egress traffic.
- `internal/server/dto/errors.go`: Defines structured error types and codes for the API.
- `internal/server/dto/request.go`: Defines API request payloads and validation logic.
- `internal/server/dto/response.go`: Defines API response payloads.
- `internal/server/dto/types.go`: Defines shared data types and enums for the API.
- `internal/server/dto/validate.go`: Defines the validation interface for requests.
- `internal/server/handler_wrapper.go`: Provides middleware for standardizing HTTP handlers.
- `internal/server/handlers/admin.go`: Handles global system administration endpoints.
- `internal/server/handlers/assets.go`: Handles file upload and retrieval for node assets.
- `internal/server/handlers/auth.go`: Handles user authentication, registration, and session management.
- `internal/server/handlers/convert.go`: Provides helper functions to convert between domain entities and DTOs.
- `internal/server/handlers/errors.go`: Provides helper functions for writing error responses.
- `internal/server/handlers/git_remotes.go`: Handles git remote configuration and synchronization.
- `internal/server/handlers/health.go`: Handles health check endpoints.
- `internal/server/handlers/invitations.go`: Handles organization and workspace invitations.
- `internal/server/handlers/memberships.go`: Handles workspace switching and membership settings.
- `internal/server/handlers/nodes.go`: Handles hierarchical node operations (documents, tables, hybrid, records).
- `internal/server/handlers/notion_import.go`: Handles Notion import endpoints for creating workspaces from Notion data.
- `internal/server/handlers/oauth.go`: Handles OAuth2 authentication with external providers.
- `internal/server/handlers/organizations.go`: Handles organization management endpoints.
- `internal/server/handlers/search.go`: Handles full-text search endpoints.
- `internal/server/handlers/server.go`: Handles server configuration endpoints for global admins.
- `internal/server/handlers/services.go`: Defines shared service dependencies for handlers.
- `internal/server/handlers/users.go`: Handles user management endpoints.
- `internal/server/ratelimit/config.go`: Defines rate limit tiers and routing rules.
- `internal/server/ratelimit/limiter.go`: Implements a thread-safe token bucket rate limiter.
- `internal/server/ratelimit/middleware.go`: Provides HTTP middleware and response writers for rate limiting.
- `internal/server/reqctx/context.go`: Defines request context keys and helper functions for metadata access.
- `internal/server/router.go`: Package server implements HTTP routing, middleware, and request handling.
- `internal/storage/agents.go`: Embeds documentation for AI agents.
- `internal/storage/config.go`: Manages server configuration stored in server_config.json.
- `internal/storage/content/coercion.go`: Implements type coercion rules for SQLite compatibility.
- `internal/storage/content/errors.go`: Defines sentinel errors for content operations.
- `internal/storage/content/filestore_service.go`: Manages workspace-scoped file storage and quotas.
- `internal/storage/content/query.go`: Provides filtering and sorting logic for records.
- `internal/storage/content/query_test.go`: Tests for filtering and sorting logic.
- `internal/storage/content/search_service.go`: Implements full-text search across content nodes.
- `internal/storage/content/types.go`: Defines the core data models for content (Node, DataRecord, Asset).
- `internal/storage/content/values.go`: Provides typed access to record data values based on property schema.
- `internal/storage/content/views.go`: Defines view types for saved table configurations.
- `internal/storage/content/views_test.go`: Tests for view types.
- `internal/storage/content/workspace_store.go`: Handles file operations within a specific workspace directory.
- `internal/storage/git/git.go`: Provides a wrapper around the git CLI for repository management.
- `internal/storage/identity/email_verification.go`: Manages email verification tokens for magic link authentication.
- `internal/storage/identity/errors.go`: Defines sentinel errors for identity operations.
- `internal/storage/identity/org_invitation.go`: Manages invitations for users to join organizations.
- `internal/storage/identity/org_membership.go`: Manages user memberships within organizations.
- `internal/storage/identity/organization.go`: Manages organization entities and their settings.
- `internal/storage/identity/session.go`: Handles active user sessions and token management.
- `internal/storage/identity/user.go`: Manages user accounts, authentication, and profiles.
- `internal/storage/identity/workspace.go`: Manages workspace entities, quotas, and settings.
- `internal/storage/identity/workspace_invitation.go`: Manages invitations for users to join workspaces.
- `internal/storage/identity/workspace_membership.go`: Manages user memberships within workspaces.
- `internal/storage/time.go`: Provides a JSON-friendly Time type with millisecond precision.
- `internal/utils/security.go`: Provides cryptographic utilities for token generation and hashing.
<!-- END FILE INDEX -->
