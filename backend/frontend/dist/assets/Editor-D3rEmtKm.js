import{c as e,ab as t,ac as o,ad as i,ae as s,af as n,ag as r,ah as a,ai as l,L as c,D as d,h as u,o as p,m as h,d as f,S as g,T as k,q as m,F as w,s as v,v as b,A as y,B as _,w as S,n as $,J as x,aj as L,ak as M,al as T,am as C,an as B,y as z,g as I}from"./vendor-C4NZ4Uo1.js";import{S as E,a as D,b as N,E as A,k as q,h as P,d as O,g as K,s as F,M as U,c as H,w as W,t as j,i as G,P as R,D as V,e as X,f as J,j as Q,l as Y,I as Z,u as ee,r as te,m as oe,n as ie,o as se,p as ne,q as re,v as ae,x as le,y as ce,z as de,A as ue,B as pe,T as he,C as fe,F as ge}from"./editor-vendor-Crzpgfli.js";import{u as ke,d as me,g as we,h as ve,i as be,n as ye,r as _e,j as Se,k as $e}from"./index-C1BGLC9Z.js";const xe=F.spec.nodes.get("list_item");if(!xe)throw new Error("list_item node not found in schema");const Le=new E({nodes:F.spec.nodes.update("list_item",{...xe,attrs:{checked:{default:null}},toDOM:e=>null!==e.attrs.checked?["li",{class:"task-list-item","data-checked":String(e.attrs.checked)},0]:["li",0],parseDOM:[{tag:"li",getAttrs:e=>e.classList.contains("task-list-item")?{checked:"true"===e.dataset.checked}:{checked:null}}]}),marks:F.spec.marks.addToEnd("underline",{parseDOM:[{tag:"u"},{style:"text-decoration=underline"}],toDOM:()=>["u",0]}).addToEnd("strikethrough",{parseDOM:[{tag:"s"},{tag:"del"},{style:"text-decoration=line-through"}],toDOM:()=>["s",0]})});function Me(e){const t=Le.nodes[e];if(!t)throw new Error(`Node type '${e}' not found in schema`);return t}function Te(e){const t=Le.marks[e];if(!t)throw new Error(`Mark type '${e}' not found in schema`);return t}const Ce={doc:Me("doc"),list_item:Me("list_item"),bullet_list:Me("bullet_list"),ordered_list:Me("ordered_list"),paragraph:Me("paragraph"),blockquote:Me("blockquote"),code_block:Me("code_block"),heading:Me("heading")},Be={strong:Te("strong"),em:Te("em"),code:Te("code"),link:Te("link"),underline:Te("underline"),strikethrough:Te("strikethrough")},ze=new U;ze.inline.ruler.before("html_inline","underline",(e,t)=>{const o=e.pos,i=e.posMax,s=e.src;if("<u>"!==s.slice(o,o+3).toLowerCase())return!1;const n="</u>",r=s.toLowerCase().indexOf(n,o+3);if(-1===r||r>=i)return!1;if(!t){e.push("underline_open","u",1).markup="<u>";const t=s.slice(o+3,r);e.push("text","",0).content=t;e.push("underline_close","u",-1).markup="</u>"}return e.pos=r+4,!0}),ze.core.ruler.after("inline","task_list",e=>{const t=e.tokens;for(let o=0;o<t.length;o++){const e=t[o];if(e&&"list_item_open"===e.type){const i=t[o+2];if(i&&"inline"===i.type&&i.children){const t=i.children[0];if(t&&"text"===t.type&&t.content){const o=t.content.match(/^\[([ xX])\]\s*/);o&&o[1]&&(e.attrSet("checked","x"===o[1].toLowerCase()?"true":"false"),t.content=t.content.slice(o[0].length))}}}}return!0});const Ie=new D(Le,ze,{blockquote:{block:"blockquote"},paragraph:{block:"paragraph"},list_item:{block:"list_item",getAttrs:e=>{const t=e.attrGet("checked");return"true"===t?{checked:!0}:"false"===t?{checked:!1}:{checked:null}}},bullet_list:{block:"bullet_list"},ordered_list:{block:"ordered_list",getAttrs:e=>({order:+(e.attrGet("start")||1)})},heading:{block:"heading",getAttrs:e=>({level:+e.tag.slice(1)})},code_block:{block:"code_block",noCloseToken:!0},fence:{block:"code_block",getAttrs:e=>({params:e.info||""}),noCloseToken:!0},hr:{node:"horizontal_rule"},image:{node:"image",getAttrs:e=>({src:e.attrGet("src"),title:e.attrGet("title")||null,alt:e.children?.[0]?.content||null})},hardbreak:{node:"hard_break"},em:{mark:"em"},strong:{mark:"strong"},underline:{mark:"underline"},s:{mark:"strikethrough"},link:{mark:"link",getAttrs:e=>({href:e.attrGet("href"),title:e.attrGet("title")||null})},code_inline:{mark:"code"},table:{block:"paragraph",noCloseToken:!1},thead:{ignore:!0},tbody:{ignore:!0},tr:{ignore:!0},th:{block:"paragraph"},td:{block:"paragraph"}}),Ee=new N({...H.nodes,bullet_list(e,t){e.renderList(t,"  ",()=>"- ")},list_item(e,t){if(null!==t.attrs.checked){const o=t.attrs.checked?"[x] ":"[ ] ";e.write(o)}e.renderContent(t)}},{...H.marks,underline:{open:"<u>",close:"</u>",mixable:!0,expelEnclosingWhitespace:!0},strikethrough:{open:"~~",close:"~~",mixable:!0,expelEnclosingWhitespace:!0}});function De(){const e=J.concat(Q,Y);e.push(new Z(/^\s*-\s+\[([ xX])\]\s$/,(e,t,o,i)=>{const s=e.doc.resolve(o),n="x"===t[1]?.toLowerCase();for(let l=s.depth;l>0;l--)if(s.node(l).type===Ce.list_item){const t=e.tr.delete(o,i);return t.setNodeMarkup(s.before(l),void 0,{checked:n}),t}const r=Ce.list_item.create({checked:n},Ce.paragraph.create()),a=Ce.bullet_list.create(null,r);return e.tr.replaceWith(o,i,a)})),e.push(W(/^\s*>\s$/,Ce.blockquote)),e.push(W(/^\s*([-*])\s$/,Ce.bullet_list)),e.push(W(/^(\d+)\.\s$/,Ce.ordered_list,e=>({order:+(e[1]??1)}),(e,t)=>t.childCount+t.attrs.order===+(e[1]??1))),e.push(j(/^```$/,Ce.code_block));for(let t=1;t<=6;t++){const o=new RegExp(`^(#{${t}})\\s$`);e.push(j(o,Ce.heading,{level:t}))}return G({rules:e})}function Ne(){const e={};return e["Mod-z"]=ee,e["Mod-y"]=te,e["Mod-Shift-z"]=te,e["Mod-b"]=oe(Be.strong),e["Mod-i"]=oe(Be.em),e["Mod-u"]=oe(Be.underline),e["Mod-Shift-x"]=oe(Be.strikethrough),e["Mod-`"]=oe(Be.code),e.Enter=(e,t)=>{const{$from:o}=e.selection;for(let i=o.depth;i>0;i--){const s=o.node(i);if(s.type===Ce.list_item&&null!==s.attrs.checked){if(t){return ie(Ce.list_item)(e,e=>{const o=e.selection.$from;for(let t=o.depth;t>0;t--){if(o.node(t).type===Ce.list_item){e.setNodeMarkup(o.before(t),void 0,{checked:!1});break}}t(e)})}return ie(Ce.list_item)(e)}}return ie(Ce.list_item)(e,t)},e.Tab=se(Ce.list_item),e["Shift-Tab"]=ne(Ce.list_item),q(e)}function Ae(e,t){return A.create({doc:e,plugins:[De(),Ne(),q(re),P(),O({color:"var(--c-primary)",width:2}),K(),new R({props:{decorations(e){const t=[];return e.doc.descendants((e,o)=>{if(e.type===Ce.list_item&&null!==e.attrs.checked){const i=document.createElement("input");i.type="checkbox",i.checked=e.attrs.checked,i.className="task-checkbox",i.addEventListener("mousedown",t=>{t.preventDefault();const i=t.target.closest(".ProseMirror");if(!i)return;const s=i.pmView;if(!s)return;const n=s.state.tr.setNodeMarkup(o,void 0,{checked:!e.attrs.checked});s.dispatch(n)}),t.push(V.widget(o+1,i,{side:-1}))}}),X.create(e.doc,t)}}}),...t||[]]})}const qe=new ae("slashMenu"),Pe={active:!1,query:"",triggerPos:0,position:{top:0,left:0}};function Oe(e){e.dispatch(e.state.tr.setMeta(qe,{close:!0}))}const Ke=new ae("dropUpload");function Fe(e,t){const o=Ke.getState(e.state);o?.isDragging!==t&&e.dispatch(e.state.tr.setMeta(Ke,{isDragging:t}))}function Ue(e){return"image/png"===e||"image/jpeg"===e||"image/gif"===e||"image/webp"===e||"image/svg+xml"===e||"image/avif"===e||"application/pdf"===e}const He=/^\/w\/([^/+]+)(?:\+[^/]*)?\/([a-zA-Z0-9_-]+)(?:\+.*)?$/,We=new ae("invalidLink");function je(e,t,o){const i=[];return e.descendants((e,s)=>{if(e.isText){const n=e.marks.find(e=>"link"===e.type.name);if(n&&n.attrs.href){(function(e,t,o){if(!o||!e)return!1;const i=e.match(He);if(!i)return e.startsWith("/w/")&&console.warn("[invalidLink] Pattern did not match:",e),!1;const s=i[1],n=i[2];return s===o&&!!n&&!(n in t)})(n.attrs.href,t,o)&&i.push(V.inline(s,s+e.nodeSize,{class:"invalid-link"}))}}return!0}),X.create(e,i)}function Ge(e,t,o){const i=e.state.tr.setMeta(We,{linkedNodeTitles:t,wsId:o});e.dispatch(i)}const Re=new Set(["image/png","image/jpeg","image/gif","image/webp","image/svg+xml","image/avif","application/pdf"]);function Ve(e){return e.startsWith("image/")}function Xe(e,t,o,i){const s=e.state.tr.delete(t,o);e.dispatch(s),i(e)}function Je(e,t,o){const{state:i}=e,{$from:s}=i.selection;for(let u=s.depth;u>0;u--){const t=s.node(u);if(t.type===Ce.bullet_list||t.type===Ce.ordered_list)return void ue(i,e.dispatch)}const n=s.before(s.depth),r=Ce.paragraph.create(),a=Ce.list_item.create(o||null,r),l=t.create(null,a),c=e.state.tr.replaceWith(n,s.after(s.depth),l),d=n+3;c.setSelection(le.near(c.doc.resolve(d))),e.dispatch(c)}const Qe=[{id:"paragraph",labelKey:"paragraph",keywords:["paragraph","text","plain"],icon:t,execute:(e,t,o)=>{Xe(e,t,o,e=>{ce(Ce.paragraph)(e.state,e.dispatch)})}},{id:"heading1",labelKey:"heading1",keywords:["heading","h1","title","header"],icon:o,execute:(e,t,o)=>{Xe(e,t,o,e=>{ce(Ce.heading,{level:1})(e.state,e.dispatch)})}},{id:"heading2",labelKey:"heading2",keywords:["heading","h2","subtitle","header"],icon:o,execute:(e,t,o)=>{Xe(e,t,o,e=>{ce(Ce.heading,{level:2})(e.state,e.dispatch)})}},{id:"heading3",labelKey:"heading3",keywords:["heading","h3","header"],icon:o,execute:(e,t,o)=>{Xe(e,t,o,e=>{ce(Ce.heading,{level:3})(e.state,e.dispatch)})}},{id:"bulletList",labelKey:"bulletList",keywords:["bullet","list","unordered","ul"],icon:i,execute:(e,t,o)=>{Xe(e,t,o,e=>{Je(e,Ce.bullet_list)})}},{id:"orderedList",labelKey:"orderedList",keywords:["ordered","list","numbered","ol"],icon:s,execute:(e,t,o)=>{Xe(e,t,o,e=>{Je(e,Ce.ordered_list)})}},{id:"taskList",labelKey:"taskList",keywords:["task","checkbox","todo","checklist","check"],icon:n,execute:(e,t,o)=>{Xe(e,t,o,e=>{Je(e,Ce.bullet_list,{checked:!1})})}},{id:"blockquote",labelKey:"blockquote",keywords:["quote","blockquote","citation"],icon:r,execute:(e,t,o)=>{Xe(e,t,o,e=>{de(Ce.blockquote)(e.state,e.dispatch)})}},{id:"codeBlock",labelKey:"codeBlock",keywords:["code","codeblock","pre","programming"],icon:a,execute:(e,t,o)=>{Xe(e,t,o,e=>{ce(Ce.code_block)(e.state,e.dispatch)})}},{id:"divider",labelKey:"divider",keywords:["divider","hr","horizontal","rule","line"],icon:l,execute:(e,t,o)=>{const i=Le.nodes.horizontal_rule;if(!i)return;let s=e.state.tr.delete(t,o);e.dispatch(s);const n=e.state.selection.$from.after(e.state.selection.$from.depth),r=i.create(),a=Ce.paragraph.create();s=e.state.tr.insert(n,[r,a]),s.setSelection(le.near(s.doc.resolve(n+2))),e.dispatch(s)}},{id:"subpage",labelKey:"subpage",keywords:["subpage","page","child","nested","link"],icon:c,asyncAction:"createSubpage",execute:()=>{}}];function Ye(e,t){const o=t.toLowerCase();return o===e?100:o.startsWith(e)?90:o.includes(e)?70:function(e,t){let o=0;for(let i=0;i<t.length&&o<e.length;i++)t[i]===e[o]&&o++;return o===e.length}(e,o)?50:0}function Ze(e,t){if(!e)return Qe;const o=e.toLowerCase(),i=Qe.map(e=>{let i=0;i=Math.max(i,Ye(o,e.labelKey));for(const t of e.keywords)i=Math.max(i,Ye(o,t));if(t){const s=t(`slashMenu.${e.labelKey}`);s&&(i=Math.max(i,Ye(o,s)))}return{cmd:e,score:i}}).filter(e=>e.score>0);return i.sort((e,t)=>t.score-e.score),i.map(e=>e.cmd)}const et="_editorContainer_1wz3o_3",tt="_floatingToolbar_1wz3o_12",ot="_above_1wz3o_31",it="_toolbarRow_1wz3o_37",st="_formatButton_1wz3o_44",nt="_isActive_1wz3o_67",rt="_separator_1wz3o_72",at="_modeIndicator_1wz3o_80",lt="_modeIndicatorActive_1wz3o_114",ct="_prosemirrorEditor_1wz3o_121",dt="_markdownEditor_1wz3o_375",ut="_hidden_1wz3o_395",pt="_slashMenu_1wz3o_400",ht="_slashMenuItem_1wz3o_414",ft="_selected_1wz3o_424",gt="_slashMenuIcon_1wz3o_428",kt="_slashMenuLabel_1wz3o_444",mt="_slashMenuEmpty_1wz3o_449";var wt=S("<div data-testid=slash-command-menu>"),vt=S("<div>"),bt=S("<div><span></span><span>");function yt(t){const{t:o}=ke(),i=d(),{user:s,wsApi:n}=me(),{loadNode:r,fetchNodeChildren:a}=we(),{flushAutoSave:l}=ve(),[c,S]=e(0),[$,x]=e(null);let L;const M=()=>Ze(t.state.query,o);u(()=>{t.state.query,t.state.active,S(0),x(null)}),u(()=>{t.state.active&&L&&requestAnimationFrame(()=>{if(!L)return;const e=L.getBoundingClientRect(),o=window.innerHeight,i=window.innerWidth;let s=t.state.position.top,n=t.state.position.left;if(0===s&&0===n)try{const e=t.view.coordsAtPos(t.state.triggerPos);s=e.bottom+4,n=e.left}catch{}if(s+e.height>o){s=t.view.coordsAtPos(t.state.triggerPos).top-e.height-4,s<0&&(s=8)}n+e.width>i&&(n=i-e.width-8),n<0&&(n=8),s===t.state.position.top&&n===t.state.position.left||x({top:s,left:n})})}),u(()=>{const e=c();if(L){const t=L.querySelector(`[data-index="${e}"]`);t&&t.scrollIntoView({block:"nearest"})}}),be(()=>L,()=>{t.state.active&&Oe(t.view)}),p(()=>{const e=e=>{const i=qe.getState(t.view.state);if(!i?.active)return;const s=Ze(i.query,o);if(0!==s.length)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),S(e=>(e+1)%s.length);break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),S(e=>(e-1+s.length)%s.length);break;case"Enter":case"Tab":e.preventDefault(),e.stopPropagation(),T(s[c()]);break;case"Escape":e.preventDefault(),e.stopPropagation(),Oe(t.view)}};document.addEventListener("keydown",e,!0),h(()=>{document.removeEventListener("keydown",e,!0)})});const T=async e=>{if(!e)return;const c=qe.getState(t.view.state);if(!c)return;const{triggerPos:d}=c,u=t.view.state.selection.from;if("createSubpage"===e.asyncAction){const e=n(),c=s(),h=t.nodeId;if(!e||!c||!h)return;const f=t.view.state.tr.delete(d,u);t.view.dispatch(f);try{const s=o("slashMenu.untitledSubpage")||"Untitled",n=await e.nodes.page.createPage(h,{title:s});if(!n?.id)return;const d=c.workspace_id,u=c.workspace_name,p=ye(d||"",u,n.id,s),f=Be.link.create({href:p,title:null}),g=Le.text(s,[f]),k=t.view.state.tr.insert(t.view.state.selection.from,g);t.view.dispatch(k),l(),await a(h),await r(n.id),i(p)}catch(p){console.error("Failed to create subpage:",p)}return void t.view.focus()}e.execute(t.view,d,u),t.view.focus()},C=()=>$()??t.state.position;return f(g,{get when(){return t.state.active},get children(){var e=wt();return"function"==typeof L?k(L,e):L=e,m(e,f(g,{get when(){return M().length>0},get fallback(){return e=vt(),m(e,()=>o("slashMenu.noResults")),v(()=>b(e,mt)),e;var e},get children(){return f(w,{get each(){return M()},children:(e,t)=>{return i=bt(),s=i.firstChild,n=s.nextSibling,i.addEventListener("mouseenter",()=>(e=>{S(e)})(t())),i.$$click=()=>(e=>{T(e)})(e),m(s,f(e.icon,{})),m(n,()=>o(`slashMenu.${e.labelKey}`)),v(e=>{var o=`${ht} ${t()===c()?ft:""}`,r=t(),a=gt,l=kt;return o!==e.e&&b(i,e.e=o),r!==e.t&&y(i,"data-index",e.t=r),a!==e.a&&b(s,e.a=a),l!==e.o&&b(n,e.o=l),e},{e:void 0,t:void 0,a:void 0,o:void 0}),i;var i,s,n}})}})),v(t=>{var o=pt,i=`${C().top}px`,s=`${C().left}px`,n=(()=>{const e=C();return 0!==e.top||0!==e.left})()?"visible":"hidden";return o!==t.e&&b(e,t.e=o),i!==t.t&&_(e,"top",t.t=i),s!==t.a&&_(e,"left",t.a=s),n!==t.o&&_(e,"visibility",t.o=n),t},{e:void 0,t:void 0,a:void 0,o:void 0}),e}})}$(["click"]);var _t=S('<div data-testid=floating-toolbar><div><button title="Bold (Ctrl+B)"></button><button title="Italic (Ctrl+I)"></button><button title="Underline (Ctrl+U)"></button><button title="Strikethrough (Ctrl+Shift+X)"></button><button title="Code (Ctrl+`)"></button></div><div><button title="Heading 1">H1</button><button title="Heading 2">H2</button><button title="Heading 3">H3</button><span></span><button title="Bullet List"></button><button title="Numbered List"></button><button title="Task List"></button><button title=Quote></button><button title="Code Block">');function St(t){let o;const[l,c]=e(!1),[d,p]=e(null);u(x(()=>t.position,()=>{if(!t.position||!o)return c(!1),void p(null);requestAnimationFrame(()=>{if(!o||!t.position)return;const e=o.getBoundingClientRect(),i=t.position.bottom+e.height+8>window.innerHeight;c(i);const s=e.width/2,n=t.editorElement?.getBoundingClientRect(),r=(n?.left??0)+s,a=(n?.right??window.innerWidth)-s,l=t.position.left;p(l<r?r:l>a?a:null)})}));const h=e=>e?`${st} ${nt}`:st,w=()=>{if(!t.view)return{isBulletList:!1,isOrderedList:!1,isTaskList:!1};const{state:e}=t.view,{from:o,to:i,$from:s}=e.selection;let n=!1,r=!1,a=!1;for(let t=s.depth;t>0;t--){const e=s.node(t);e.type===Ce.bullet_list&&(n=!0),e.type===Ce.ordered_list&&(r=!0),e.type===Ce.list_item&&null!==e.attrs.checked&&(a=!0)}return n||r||a||e.doc.nodesBetween(o,i,e=>{e.type===Ce.bullet_list&&(n=!0),e.type===Ce.ordered_list&&(r=!0),e.type===Ce.list_item&&null!==e.attrs.checked&&(a=!0)}),a&&(n=!1),{isBulletList:n,isOrderedList:r,isTaskList:a}},y=()=>{t.view&&(oe(Be.strong)(t.view.state,t.view.dispatch),t.view.focus())},S=()=>{t.view&&(oe(Be.em)(t.view.state,t.view.dispatch),t.view.focus())},$=()=>{t.view&&(oe(Be.underline)(t.view.state,t.view.dispatch),t.view.focus())},z=()=>{t.view&&(oe(Be.strikethrough)(t.view.state,t.view.dispatch),t.view.focus())},I=()=>{t.view&&(oe(Be.code)(t.view.state,t.view.dispatch),t.view.focus())},E=e=>{if(!t.view)return;const{state:o,dispatch:i}=t.view;t.formatState.headingLevel===e?ce(Ce.paragraph)(o,i):ce(Ce.heading,{level:e})(o,i),t.view.focus()},D=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view,{from:i,to:s,$from:n}=e.selection;let r=null,a=0;for(let t=n.depth;t>0;t--){const e=n.node(t);if(e.type===Ce.bullet_list||e.type===Ce.ordered_list){r=e,a=n.before(t);break}}if(r||e.doc.nodesBetween(i,s,(e,t)=>{r||e.type!==Ce.bullet_list&&e.type!==Ce.ordered_list||(r=e,a=t)}),r){const t=a+r.nodeSize,n=e.selection instanceof pe||i<=1&&s>=e.doc.content.size-1,l=i>=a&&s<=t,c=[];r.forEach(e=>{e.forEach(e=>{c.push(e)})});let d=0;for(const e of c)d+=e.nodeSize;const u=e.tr.replaceWith(a,t,c);if(n)u.setSelection(new pe(u.doc));else if(i!==s&&l)try{const e=a+1,t=a+d-1;u.setSelection(he.create(u.doc,e,t))}catch{u.setSelection(le.near(u.doc.resolve(a)))}else if(i!==s)try{const e=u.mapping.map(i),t=u.mapping.map(s);u.setSelection(he.create(u.doc,e,t))}catch{u.setSelection(le.near(u.doc.resolve(a)))}o(u)}},N=e=>{if(!t.view)return;const{state:o,dispatch:i}=t.view,{from:s,to:n,$from:r}=o.selection;let a=null,l=0;for(let t=r.depth;t>0;t--){const e=r.node(t);if(e.type===Ce.bullet_list||e.type===Ce.ordered_list){a=e,l=r.before(t);break}}if(a||o.doc.nodesBetween(s,n,(e,t)=>{a||e.type!==Ce.bullet_list&&e.type!==Ce.ordered_list||(a=e,l=t)}),a){const t=o.selection instanceof pe||s<=1&&n>=o.doc.content.size-1,r=o.tr.setNodeMarkup(l,e);if(e===Ce.ordered_list&&r.doc.nodesBetween(l,l+a.nodeSize,(e,t)=>{e.type===Ce.list_item&&null!==e.attrs.checked&&r.setNodeMarkup(t,void 0,{checked:null})}),t)r.setSelection(new pe(r.doc));else if(s!==n)try{const e=r.mapping.map(s),t=r.mapping.map(n);r.setSelection(he.create(r.doc,e,t))}catch{}i(r)}},A=e=>{if(!t.view)return;const{state:o,dispatch:i}=t.view,{from:s,to:n}=o.selection,r=o.selection instanceof pe||s<=1&&n>=o.doc.content.size-1;fe(e)(o,e=>{if(r)e.setSelection(new pe(e.doc));else if(s!==n)try{const t=e.mapping.map(s),o=e.mapping.map(n);e.setSelection(he.create(e.doc,t,o))}catch{}i(e)})},q=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view,{from:i,to:s}=e.selection,n=w();if(n.isBulletList)D();else if(n.isOrderedList)N(Ce.bullet_list);else if(n.isTaskList){const{$from:t}=e.selection,n=e.selection instanceof pe||i<=1&&s>=e.doc.content.size-1;for(let r=t.depth;r>0;r--){const a=t.node(r);if(a.type===Ce.bullet_list){const l=t.before(r);let c=e.tr;if(e.doc.nodesBetween(l,l+a.nodeSize,(e,t)=>{e.type===Ce.list_item&&null!==e.attrs.checked&&(c=c.setNodeMarkup(t,void 0,{checked:null}))}),c.docChanged){if(n)c.setSelection(new pe(c.doc));else if(i!==s)try{const e=c.mapping.map(i),t=c.mapping.map(s);c.setSelection(he.create(c.doc,e,t))}catch{}o(c)}break}}}else A(Ce.bullet_list);t.view.focus()},P=()=>{if(!t.view)return;const e=w();e.isOrderedList?D():e.isBulletList||e.isTaskList?N(Ce.ordered_list):A(Ce.ordered_list),t.view.focus()},O=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view,{from:i,to:s,$from:n}=e.selection,r=t=>{for(let e=n.depth;e>0;e--){const o=n.node(e);if(o.type===t)return{start:n.before(e),node:o}}let o=null;return e.doc.nodesBetween(i,s,(e,i)=>{o||e.type!==t||(o={start:i,node:e})}),o},a=e.selection instanceof pe||i<=1&&s>=e.doc.content.size-1,l=e=>{if(a)e.setSelection(new pe(e.doc));else if(i!==s)try{const t=e.mapping.map(i),o=e.mapping.map(s);e.setSelection(he.create(e.doc,t,o))}catch{}},c=w();if(c.isTaskList)D();else if(c.isBulletList){const t=r(Ce.bullet_list);if(t){let i=e.tr;e.doc.nodesBetween(t.start,t.start+t.node.nodeSize,(e,t)=>{e.type===Ce.list_item&&null===e.attrs.checked&&(i=i.setNodeMarkup(t,void 0,{checked:!1}))}),i.docChanged&&(l(i),o(i))}}else if(c.isOrderedList){const t=r(Ce.ordered_list);if(t){let i=e.tr.setNodeMarkup(t.start,Ce.bullet_list);i.doc.nodesBetween(t.start,t.start+t.node.nodeSize,(e,t)=>{e.type===Ce.list_item&&(i=i.setNodeMarkup(t,void 0,{checked:!1}))}),l(i),o(i)}}else fe(Ce.bullet_list)(e,e=>{let t=e;e.doc.descendants((e,o)=>{e.type===Ce.list_item&&null===e.attrs.checked&&(t=t.setNodeMarkup(o,void 0,{checked:!1}))}),l(t),o(t)});t.view.focus()},K=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view;t.formatState.isBlockquote?ue(e,o):de(Ce.blockquote)(e,o),t.view.focus()},F=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view;t.formatState.isCodeBlock?ce(Ce.paragraph)(e,o):ce(Ce.code_block)(e,o),t.view.focus()};return f(g,{get when(){return t.position},get children(){var e=_t(),c=e.firstChild,u=c.firstChild,p=u.nextSibling,g=p.nextSibling,w=g.nextSibling,x=w.nextSibling,D=c.nextSibling,N=D.firstChild,A=N.nextSibling,U=A.nextSibling,H=U.nextSibling,W=H.nextSibling,j=W.nextSibling,G=j.nextSibling,R=G.nextSibling,V=R.nextSibling;return"function"==typeof o?k(o,e):o=e,u.$$click=y,m(u,f(L,{})),p.$$click=S,m(p,f(M,{})),g.$$click=$,m(g,f(T,{})),w.$$click=z,m(w,f(C,{})),x.$$click=I,m(x,f(a,{})),N.$$click=()=>E(1),A.$$click=()=>E(2),U.$$click=()=>E(3),W.$$click=q,m(W,f(i,{})),j.$$click=P,m(j,f(s,{})),G.$$click=O,m(G,f(n,{})),R.$$click=K,m(R,f(r,{})),V.$$click=F,m(V,f(B,{})),v(o=>{var i=`${tt} ${l()?ot:""}`,s=`${l()?t.position?.top:t.position?.bottom}px`,n=`${d()??t.position?.left??0}px`,r=it,a=h(t.formatState.isBold),f=h(t.formatState.isItalic),k=h(t.formatState.isUnderline),m=h(t.formatState.isStrikethrough),v=h(t.formatState.isCode),y=it,S=h(1===t.formatState.headingLevel),$=h(2===t.formatState.headingLevel),L=h(3===t.formatState.headingLevel),M=rt,T=h(t.formatState.isBulletList),C=h(t.formatState.isOrderedList),B=h(t.formatState.isTaskList),z=h(t.formatState.isBlockquote),I=h(t.formatState.isCodeBlock);return i!==o.e&&b(e,o.e=i),s!==o.t&&_(e,"top",o.t=s),n!==o.a&&_(e,"left",o.a=n),r!==o.o&&b(c,o.o=r),a!==o.i&&b(u,o.i=a),f!==o.n&&b(p,o.n=f),k!==o.s&&b(g,o.s=k),m!==o.h&&b(w,o.h=m),v!==o.r&&b(x,o.r=v),y!==o.d&&b(D,o.d=y),S!==o.l&&b(N,o.l=S),$!==o.u&&b(A,o.u=$),L!==o.c&&b(U,o.c=L),M!==o.w&&b(H,o.w=M),T!==o.m&&b(W,o.m=T),C!==o.f&&b(j,o.f=C),B!==o.y&&b(G,o.y=B),z!==o.g&&b(R,o.g=z),I!==o.p&&b(V,o.p=I),o},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0,w:void 0,m:void 0,f:void 0,y:void 0,g:void 0,p:void 0}),e}})}$(["click"]);var $t=S('<div><div data-testid=wysiwyg-editor></div><textarea data-testid=markdown-editor></textarea><div><button title="Visual mode (Ctrl+Shift+M)"data-testid=editor-mode-visual>Visual</button><button title="Markdown mode (Ctrl+Shift+M)"data-testid=editor-mode-markdown>MD');function xt(t){const{t:o}=ke(),[i,s]=e("wysiwyg"),[n,r]=e(z(()=>t.content)),[a,l]=e(),[c,d]=e({active:!1,query:"",triggerPos:0,position:{top:0,left:0}}),[w,_]=e(),S=($=d,new R({key:qe,state:{init:()=>({...Pe}),apply(e,t,o,i){const s=e.getMeta(qe);if(s?.close){if(t.active){const e={...Pe};return setTimeout(()=>$(e),0),e}return t}if(!e.docChanged&&!e.selectionSet)return t;const{selection:n}=i,{$from:r}=n;if(!n.empty){if(t.active){const e={...Pe};return setTimeout(()=>$(e),0),e}return t}const a=r.start(r.depth),l=i.doc.textBetween(a,r.pos,"",""),c=l.match(/(^|\s)\/([^\s]*)$/);if(c){const e=c[2]||"",o={active:!0,query:e,triggerPos:a+(l.length-c[0].length+(c[1]?1:0)),position:t.position};return t.active&&e!==t.query&&setTimeout(()=>$(o),0),o}if(t.active){const e={...Pe};return setTimeout(()=>$(e),0),e}return t}},view:e=>({update(e){const t=qe.getState(e.state);if(t?.active)try{const o=e.coordsAtPos(t.triggerPos),i=o.bottom+4,s=o.left,n=i>0||s>0?{top:i,left:s}:t.position,r={...t,position:n};$(r)}catch{$(t)}}}),props:{handleKeyDown(e,t){const o=qe.getState(e.state);return!!o?.active&&("ArrowDown"===t.key||"ArrowUp"===t.key||"Enter"===t.key||"Tab"===t.key||"Escape"===t.key&&(Oe(e),!0))}}}));var $;const L=new R({key:We,state:{init:()=>({decorations:X.empty,linkedNodeTitles:{},wsId:void 0}),apply(e,t,o,i){const s=e.getMeta(We);if(s){const e=s.linkedNodeTitles??t.linkedNodeTitles,o=s.wsId??t.wsId;return{decorations:je(i.doc,e,o),linkedNodeTitles:e,wsId:o}}return e.docChanged?{...t,decorations:je(i.doc,t.linkedNodeTitles,t.wsId)}:{...t,decorations:t.decorations.map(e.mapping,e.doc)}}},props:{decorations:e=>We.getState(e)?.decorations??X.empty}}),M=(T={onFileDrop:async(o,i)=>{const s=a();if(!(s&&t.wsId&&t.nodeId&&t.getToken))return;const{uploadFile:n,error:r}=function(t){const[o,i]=e(!1),[s,n]=e(null);return{uploadFile:async e=>{if(n(null),e.size>10485760){const t=`File too large: ${e.name} (max 10MB)`;return n(t),console.error(t),null}if(!Re.has(e.type)){const t=`Unsupported file type: ${e.type}`;return n(t),console.error(t),null}const o=t.getToken();if(!o){const e="Not authenticated";return n(e),console.error(e),null}i(!0);try{const i=new FormData;i.append("file",e);const s=await fetch(`/api/workspaces/${t.wsId}/nodes/${t.nodeId}/assets`,{method:"POST",headers:{Authorization:`Bearer ${o}`},body:i});if(!s.ok){const e=await s.text();throw new Error(`Upload failed: ${s.status} ${e}`)}const n=await s.json();return{name:n.name,mimeType:n.mime_type,url:n.url}}catch(s){const e=s instanceof Error?s.message:String(s);return n(e),console.error("Asset upload failed:",s),null}finally{i(!1)}},uploading:o,error:s}}({wsId:t.wsId,nodeId:t.nodeId,getToken:t.getToken});for(const e of o){const o=await n(e);if(o){const e=Ve(o.mimeType);let n=s.state.tr;if(e){const e=Le.nodes.image;if(e){const t=e.create({src:o.url,alt:o.name,title:null});n=n.insert(i,t)}}else{const e=Le.marks.link;if(e){const t=e.create({href:o.url,title:null}),s=Le.text(o.name,[t]);n=n.insert(i,s)}}s.dispatch(n),t.onAssetUploaded?.()}else{const e=r();e&&t.onError?.(e)}}}},new R({key:Ke,state:{init:()=>({isDragging:!1}),apply(e,t){const o=e.getMeta(Ke);return void 0!==o?{isDragging:o.isDragging}:t}},props:{attributes(e){const t=Ke.getState(e);return t?.isDragging?{class:"drop-target-active"}:{}},handleDOMEvents:{dragenter:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),Fe(e,!0),!1),dragover:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),!1),dragleave(e,t){const o=t.relatedTarget,i=e.dom;return o&&i.contains(o)||Fe(e,!1),!1},drop(e,t){Fe(e,!1);const o=t.dataTransfer?.files;if(!o||0===o.length)return!1;const i=[];for(const n of o)Ue(n.type)&&i.push(n);if(0===i.length)return!1;t.preventDefault();const s=e.posAtCoords({left:t.clientX,top:t.clientY});return s?(T.onFileDrop(i,s.pos),!0):(T.onFileDrop(i,e.state.doc.content.size),!0)}}}}));var T;let C=z(()=>t.nodeId),B=z(()=>t.content),E=z(()=>t.linkedNodeTitles);const[D,N]=e({isBold:!1,isItalic:!1,isUnderline:!1,isStrikethrough:!1,isCode:!1,headingLevel:null,isBulletList:!1,isOrderedList:!1,isTaskList:!1,isBlockquote:!1,isCodeBlock:!1}),[A,q]=e(null),P=e=>{let o=_e(e,t.assetUrls||{});return t.wsId&&t.linkedNodeTitles&&Object.keys(t.linkedNodeTitles).length>0&&(o=Se(o,t.linkedNodeTitles,t.wsId)),Ie.parse(o)},O=e=>{const o=Ee.serialize(e);return $e(o,t.assetUrls||{})},K=e=>{const{state:t}=e,{from:o,$from:s,to:n,empty:r}=t.selection;if(r||"markdown"===i())q(null);else try{const t=e.coordsAtPos(o),i=e.coordsAtPos(n),s=Math.abs(t.top-i.top)<20;let r=t.left;r=s?(t.left+i.right)/2:t.left+40,q({top:t.top,bottom:i.bottom,left:r})}catch{q(null)}const a=r?t.storedMarks||s.marks():[],l=void 0!==Be.strong.isInSet(a)||t.doc.rangeHasMark(o,n,Be.strong),c=void 0!==Be.em.isInSet(a)||t.doc.rangeHasMark(o,n,Be.em),d=void 0!==Be.underline.isInSet(a)||t.doc.rangeHasMark(o,n,Be.underline),u=void 0!==Be.strikethrough.isInSet(a)||t.doc.rangeHasMark(o,n,Be.strikethrough),p=void 0!==Be.code.isInSet(a)||t.doc.rangeHasMark(o,n,Be.code),h=s.node(s.depth),f=h.type===Ce.heading?h.attrs.level:null,g=h.type===Ce.code_block;let k=!1,m=!1,w=!1,v=!1;for(let i=s.depth;i>0;i--){const e=s.node(i);e.type===Ce.bullet_list&&(k=!0),e.type===Ce.ordered_list&&(m=!0),e.type===Ce.list_item&&null!==e.attrs.checked&&(w=!0),e.type===Ce.blockquote&&(v=!0)}k||m||w||t.doc.nodesBetween(o,n,e=>{e.type===Ce.bullet_list&&(k=!0),e.type===Ce.ordered_list&&(m=!0),e.type===Ce.list_item&&null!==e.attrs.checked&&(w=!0),e.type===Ce.blockquote&&(v=!0)}),w&&(k=!1),N({isBold:l,isItalic:c,isUnderline:d,isStrikethrough:u,isCode:p,headingLevel:f,isBulletList:k,isOrderedList:m,isTaskList:w,isBlockquote:v,isCodeBlock:g})};p(()=>{const e=w();if(!e)return;const o=P(t.content);if(!o)return;const i=Ae(o,[S,M,L]),s=new ge(e,{state:i,editable:()=>!t.readOnly,dispatchTransaction(e){const o=s.state.apply(e);if(s.updateState(o),e.docChanged){const e=O(o.doc);r(e),B=e,t.onChange(e)}K(s)},handleDOMEvents:{click:(e,o)=>{const i=o.target.closest("a");if(!i)return!1;const s=i.getAttribute("href");if(!s)return!1;const n=s.match(He);return n&&n[2]&&t.onNavigateToNode?(o.preventDefault(),t.onNavigateToNode(n[2]),!0):!(!s.startsWith("http://")&&!s.startsWith("https://"))&&(o.preventDefault(),window.open(s,"_blank","noopener,noreferrer"),!0)}}}),n=e.querySelector(".ProseMirror");n&&(n.pmView=s),l(s),K(s),Ge(s,t.linkedNodeTitles||{},t.wsId);const a=()=>K(s),c=e.closest('[class*="prosemirrorEditor"]')||e;c.addEventListener("scroll",a,{passive:!0}),window.addEventListener("scroll",a,{passive:!0}),h(()=>{s.destroy(),c.removeEventListener("scroll",a),window.removeEventListener("scroll",a)})}),u(x(()=>[t.nodeId,t.content,t.linkedNodeTitles],([e,o,i])=>{const n=e!==C,l=o!==B;if(n||l||i!==E){C=e,B=o,E=i,(n||l)&&(r(o),s("wysiwyg"));const c=a();if(c){const e=P(o);if(e){const o=Ae(e,[S,M,L]);c.updateState(o),Ge(c,i||{},t.wsId)}}}},{defer:!0}));const F=()=>{const e=a();if(e){const o=P(n());if(o){const i=Ae(o,[S,M,L]);e.updateState(i),K(e),Ge(e,t.linkedNodeTitles||{},t.wsId)}}s("wysiwyg")},U=()=>{const e=a();if(e){const t=O(e.state.doc);r(t)}s("markdown")},H=e=>{e.ctrlKey&&e.shiftKey&&"m"===e.key.toLowerCase()&&(e.preventDefault(),"wysiwyg"===i()?U():F())};p(()=>{document.addEventListener("keydown",H)}),h(()=>{document.removeEventListener("keydown",H)});const W=I(()=>"wysiwyg"===i()?ct:`${ct} ${ut}`),j=I(()=>"markdown"===i()?dt:`${dt} ${ut}`);return G=$t(),V=G.firstChild,J=V.nextSibling,Q=J.nextSibling,Y=Q.firstChild,Z=Y.nextSibling,m(G,f(St,{get formatState(){return D()},get view(){return a()},get position(){return A()},get editorElement(){return w()}}),V),k(_,V),J.$$input=e=>{return o=e.target.value,r(o),B=o,void t.onChange(o);var o},Y.$$click=F,Z.$$click=U,m(G,f(g,{get when(){return a()},children:e=>f(yt,{get view(){return e()},get state(){return c()},get nodeId(){return t.nodeId}})}),null),v(e=>{var s=et,n=W(),r=j(),a=t.placeholder||o("editor.contentPlaceholder")||"Write markdown...",l=t.readOnly,c=at,d="wysiwyg"===i()?lt:void 0,u="markdown"===i()?lt:void 0;return s!==e.e&&b(G,e.e=s),n!==e.t&&b(V,e.t=n),r!==e.a&&b(J,e.a=r),a!==e.o&&y(J,"placeholder",e.o=a),l!==e.i&&(J.readOnly=e.i=l),c!==e.n&&b(Q,e.n=c),d!==e.s&&b(Y,e.s=d),u!==e.h&&b(Z,e.h=u),e},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),v(()=>J.value=n()),G;var G,V,J,Q,Y,Z}$(["input","click"]);export{xt as default};
