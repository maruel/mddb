import{d as e,v as t,w as n,C as o,S as r,x as s,ac as a,c as i,o as l,n as d,s as c,ae as u,af as p,ag as h,ah as g,ai as f,aj as k,ak as v,al as m,am as b,an as y,T as w,h as $,ao as S,Q as _,G as x,L as M,F as C,B as T,q as D,i as E,ap as q,aq as A,ar as L,as as I,at as P,z as N,g as O}from"./vendor-DudX5Zyp.js";import{S as B,s as z,i as K,I as H,a as U,e as j,b as F,k as W,P as Y,c as R,D as X,d as G,E as V,h as Q,f as Z,g as J,j as ee,l as te,m as ne,M as oe,N as re,n as se,t as ae,o as ie}from"./editor-vendor-C_rEih6H.js";import{R as le,u as de,C as ce,d as ue,g as pe,h as he,i as ge,n as fe}from"./index-Bs5Rbtnk.js";const ke="_indicator_dzd4r_1";var ve=s("<div role=presentation aria-hidden=true>");function me(s){return e(r,{get when(){return s.visible},get children(){var e=ve();return t(t=>{var r=ke,a=`${s.y}px`,i=24*(s.indent||0)+"px";return r!==t.e&&n(e,t.e=r),a!==t.t&&o(e,"top",t.t=a),i!==t.a&&o(e,"left",t.a=i),t},{e:void 0,t:void 0,a:void 0}),e}})}function be(e){return!e.includes("://")&&!e.startsWith("/")}const ye=/^\/assets\/[^/]+\/[^/]+\/([^?]+)/;function we(e){const t=e.match(ye);return t&&t[1]?decodeURIComponent(t[1]):null}function $e(e,t){const n={};for(const[r,s]of Object.entries(t||{}))n[s]=r;let o=e.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,(e,t,o)=>{const r=n[s=o]?n[s]:we(s);var s;return r?`![${t}](${r})`:e});return o=o.replace(/\[([^\]]+)\]\(([^)]+)\)/g,(e,t,n)=>{const o=we(n);return o?`[${t}](${o})`:e}),o}const Se={attrs:{type:{default:"paragraph"},level:{default:null},indent:{default:0},checked:{default:null},number:{default:null},language:{default:null}},content:"inline*",group:"block",parseDOM:[{tag:"h1",attrs:{type:"heading",level:1}},{tag:"h2",attrs:{type:"heading",level:2}},{tag:"h3",attrs:{type:"heading",level:3}},{tag:"h4",attrs:{type:"heading",level:4}},{tag:"h5",attrs:{type:"heading",level:5}},{tag:"h6",attrs:{type:"heading",level:6}},{tag:"li.task-list-item",getAttrs:e=>({type:"task",checked:"true"===e.dataset.checked,indent:parseInt(e.dataset.indent||"0",10)})},{tag:"li",getAttrs:e=>({type:"number"===e.dataset.type?"number":"bullet",indent:parseInt(e.dataset.indent||"0",10)})},{tag:"blockquote",attrs:{type:"quote"}},{tag:"pre",getAttrs(e){let t=e.dataset.language||null;if(!t){const n=Array.from(e.classList);for(const e of n){if(e.startsWith("language-")){t=e.slice(9);break}if(e.startsWith("lang-")){t=e.slice(5);break}if(e.startsWith("hljs-")){t=e.slice(5);break}}}return{type:"code",language:t}}},{tag:"hr",attrs:{type:"divider"}},{tag:"p",attrs:{type:"paragraph"}}],toDOM(e){const{type:t,level:n,indent:o,checked:r,language:s}=e.attrs,a={"data-type":t,"data-indent":String(o)};switch(t){case"heading":return[`h${n||1}`,a,0];case"bullet":case"number":return["div",{...a,class:`block-${t}`},0];case"task":return["div",{...a,class:"block-task","data-checked":String(r||!1)},0];case"quote":return["blockquote",a,0];case"code":return["pre",{...a,"data-language":s||""},["code",0]];case"divider":return["hr",a];default:return["p",a,0]}}},_e={attrs:{type:{default:"divider"},indent:{default:0}},content:"inline*",group:"block",parseDOM:[{tag:"hr",attrs:{type:"divider"}}],toDOM:e=>["hr",{"data-type":"divider","data-indent":String(e.attrs.indent)}]},xe=new B({nodes:z.spec.nodes.remove("bullet_list").remove("ordered_list").remove("list_item").remove("paragraph").remove("heading").remove("blockquote").remove("code_block").remove("horizontal_rule").addToEnd("block",Se).addToEnd("divider",_e),marks:z.spec.marks.addToEnd("underline",{parseDOM:[{tag:"u"},{style:"text-decoration=underline"}],toDOM:()=>["u",0]}).addToEnd("strikethrough",{parseDOM:[{tag:"s"},{tag:"del"},{style:"text-decoration=line-through"}],toDOM:()=>["s",0]})});function Me(e){const t=xe.nodes[e];if(!t)throw new Error(`Node type '${e}' not found in schema`);return t}function Ce(e){const t=xe.marks[e];if(!t)throw new Error(`Mark type '${e}' not found in schema`);return t}const Te={doc:Me("doc"),block:Me("block"),divider:Me("divider")},De={strong:Ce("strong"),em:Ce("em"),code:Ce("code"),link:Ce("link"),underline:Ce("underline"),strikethrough:Ce("strikethrough")};function Ee(e,t){return new H(e,(e,n,o,r)=>{const s=e.doc.resolve(o);if(0!==s.parentOffset)return null;const a=s.before(1),i=t(n);return e.tr.delete(o,r).setNodeMarkup(a,void 0,i)})}function qe(e){return["bullet","number","task"].includes(e)}function Ae(e){const{$from:t}=e.selection,n=t.before(1);return{node:e.doc.nodeAt(n),pos:n,$from:t}}const Le=(e,t)=>{const{node:n,pos:o}=Ae(e);if(!n)return!1;const{type:r,indent:s}=n.attrs;return!!qe(r)&&(!(s>=8)&&(t&&t(e.tr.setNodeMarkup(o,void 0,{...n.attrs,indent:s+1})),!0))},Ie=(e,t)=>{const{node:n,pos:o}=Ae(e);if(!n)return!1;const{indent:r}=n.attrs;return!(r<=0)&&(t&&t(e.tr.setNodeMarkup(o,void 0,{...n.attrs,indent:r-1})),!0)},Pe=(e,t)=>{const{$from:n,empty:o}=e.selection;if(!o)return!1;const{node:r,pos:s}=Ae(e);if(!r)return!1;const{type:a,indent:i}=r.attrs;if(!qe(a))return!1;if(0===r.content.size){if(t){const n=i>0?{type:a,indent:i-1,checked:"task"!==a&&null}:{type:"paragraph",indent:0,checked:null};t(e.tr.setNodeMarkup(s,void 0,n))}return!0}if(t){const o=n.pos,s={...r.attrs};"task"===a&&(s.checked=!1),t(e.tr.split(o,1,[{type:r.type,attrs:s}]))}return!0},Ne=(e,t)=>{const{$from:n,empty:o}=e.selection;if(!o||0!==n.parentOffset)return!1;const{node:r,pos:s}=Ae(e);if(!r)return!1;const{type:a,indent:i}=r.attrs;return i>0?(t&&t(e.tr.setNodeMarkup(s,void 0,{...r.attrs,indent:i-1})),!0):!!["bullet","number","task","quote"].includes(a)&&(t&&t(e.tr.setNodeMarkup(s,void 0,{type:"paragraph",indent:0,checked:null,level:null,language:null})),!0)};const Oe=new R("blockDrag"),Be={sourcePos:null,dropTarget:null,dropIndicatorY:null,selectedPositions:null};function ze(e){const t=[],n=e.doc.resolve(e.selection.from),o=e.doc.resolve(e.selection.to),r=n.blockRange(o);if(r&&"doc"===r.parent.type.name){let e=r.start;for(let n=r.startIndex;n<r.endIndex;n++){const o=r.parent.child(n);"block"===o.type.name&&t.push(e),e+=o.nodeSize}return t}return n.sameParent(o)&&"block"===n.parent.type.name?(t.push(n.before(n.depth)),t):(e.doc.nodesBetween(e.selection.from,e.selection.to,(e,n)=>("block"===e.type.name&&n>=0&&t.push(n),!0)),t)}function Ke(e,t){return e.setMeta(Oe,t)}function He(e){return Oe.getState(e)??Be}function Ue(e){return e.setMeta(Oe,Be)}function je(e,t,n){if(0===t.length)return!1;const{state:o}=e;let r=o.tr;const s=[...t].sort((e,t)=>t-e),a=[];for(const c of s){const e=o.doc.nodeAt(c);e&&a.push({node:e,pos:c})}if(0===a.length)return!1;let i=n;for(const{node:c,pos:u}of a)c&&u<n&&(i-=c.nodeSize);for(const{node:c,pos:u}of a)c&&(r=r.delete(u,u+c.nodeSize));const l=[...a].reverse();let d=i;for(const{node:c}of l)c&&(r=r.insert(d,c),d+=c.nodeSize);return r=Ue(r),e.dispatch(r),!0}const Fe=new Y({key:Oe,state:{init:()=>Be,apply(e,t){const n=e.getMeta(Oe);return n?{...t,...n}:t}},props:{handleDOMEvents:{dragover(e,t){const n=He(e.state);if(null===n.sourcePos&&null===n.selectedPositions)return!1;t.preventDefault(),t.dataTransfer&&(t.dataTransfer.dropEffect="move");const o=function(e,t,n){const o={left:t,top:n},r=e.posAtCoords(o);if(!r)return null;const s=e.state.doc.resolve(r.pos);let a=s.depth;for(;a>0&&!s.node(a).isBlock;)a--;if(0===a){const t=e.state.doc;let o=null,r=1/0;if(t.forEach((t,s)=>{if("block"===t.type.name){const a=e.coordsAtPos(s),i=e.coordsAtPos(s+t.nodeSize),l=(a.top+i.bottom)/2,d=Math.abs(n-l);d<r&&(r=d,o={pos:s,top:a.top,bottom:i.bottom})}}),!o)return null;const s=o,a=(s.top+s.bottom)/2,i=n<a,l=t.nodeAt(s.pos);return l?{pos:i?s.pos:s.pos+l.nodeSize,y:i?s.top:s.bottom,above:i}:null}const i=s.before(a),l=s.after(a),d=e.coordsAtPos(i),c=e.coordsAtPos(l),u=(d.top+c.bottom)/2,p=n<u;return{pos:p?i:l,y:p?d.top:c.bottom,above:p}}(e,t.clientX,t.clientY);return o&&e.dispatch(Ke(e.state.tr,{dropTarget:o.pos,dropIndicatorY:o.y})),!0},drop(e,t){const n=He(e.state),{sourcePos:o,dropTarget:r,selectedPositions:s}=n;return s&&s.length>0&&null!==r?(t.preventDefault(),je(e,s,r)):null!==o&&null!==r?(t.preventDefault(),je(e,[o],r)):(e.dispatch(Ue(e.state.tr)),!1)},dragend:e=>(e.dispatch(Ue(e.state.tr)),!1),dragleave(e,t){const n=t.relatedTarget;return e.dom.contains(n)||e.dispatch(Ke(e.state.tr,{dropTarget:null,dropIndicatorY:null})),!1}},decorations(e){const t=this.getState(e);return t&&t.dropIndicatorY,X.empty}}}),We=new R("blockSelection"),Ye=new Y({key:We,props:{decorations(e){const t=ze(e);if(t.length<=1)return X.empty;const n=[],{doc:o}=e;for(const r of t){const e=o.nodeAt(r);e&&n.push(G.node(r,r+e.nodeSize,{class:"in-selection"}))}return X.create(o,n)}}}),Re=new Y({appendTransaction(e,t,n){if(!e.some(e=>e.docChanged))return null;const o=n.tr;let r=!1;const s=new Map;return n.doc.forEach((e,t)=>{if("block"!==e.type.name)return;const n=e.attrs.indent||0;if("number"===e.attrs.type){const a=(s.get(n)||0)+1;s.set(n,a);for(const[e]of s)e>n&&s.delete(e);e.attrs.number!==a&&(o.setNodeMarkup(t,void 0,{...e.attrs,number:a}),r=!0)}else for(const[o]of s)n<=o&&s.delete(o)}),r?o:null}});function Xe(e,t){return V.create({doc:e,schema:xe,plugins:[K({rules:[Ee(/^[-*]\s$/,()=>({type:"bullet",indent:0,level:null,checked:null,language:null})),Ee(/^(\d+)\.\s$/,()=>({type:"number",indent:0,level:null,checked:null,language:null})),Ee(/^[-*]\s*\[\s\]\s$/,()=>({type:"task",indent:0,checked:!1,level:null,language:null})),Ee(/^\[\s\]\s$/,()=>({type:"task",indent:0,checked:!1,level:null,language:null})),Ee(/^[-*]\s*\[[xX]\]\s$/,()=>({type:"task",indent:0,checked:!0,level:null,language:null})),Ee(/^\[[xX]\]\s$/,()=>({type:"task",indent:0,checked:!0,level:null,language:null})),Ee(/^#\s$/,()=>({type:"heading",level:1,indent:0,checked:null,language:null})),Ee(/^##\s$/,()=>({type:"heading",level:2,indent:0,checked:null,language:null})),Ee(/^###\s$/,()=>({type:"heading",level:3,indent:0,checked:null,language:null})),Ee(/^####\s$/,()=>({type:"heading",level:4,indent:0,checked:null,language:null})),Ee(/^#####\s$/,()=>({type:"heading",level:5,indent:0,checked:null,language:null})),Ee(/^######\s$/,()=>({type:"heading",level:6,indent:0,checked:null,language:null})),Ee(/^>\s$/,()=>({type:"quote",indent:0,level:null,checked:null,language:null})),new H(/^```(\w*)\s$/,(e,t,n,o)=>{const r=e.doc.resolve(n);if(0!==r.parentOffset)return null;const s=r.before(1);return e.tr.delete(n,o).setNodeMarkup(s,void 0,{type:"code",language:t[1]||null,indent:0,level:null,checked:null})}),new H(/^(---|—-|—)$/,(e,t,n,o)=>{const r=e.doc.resolve(n).before(1),s=e.doc.nodeAt(r);return s&&s.textContent.length===t[0].length-1?e.tr.delete(n,o).setNodeMarkup(r,void 0,{type:"divider",indent:0,level:null,checked:null,language:null}):null}),...U,j,F]}),W({Tab:Le,"Shift-Tab":Ie,Enter:Pe,Backspace:Ne}),W(ee),Q(),Fe,Ye,Re,Z({color:"var(--c-primary)",width:2}),J(),...t||[]]})}let Ge=te(z.spec.nodes,"paragraph block*","block");const Ve=Ge.get("list_item");Ve&&(Ge=Ge.update("list_item",{...Ve,attrs:{...Ve.attrs,checked:{default:null}}}));let Qe=z.spec.marks;Qe.get("underline")||(Qe=Qe.addToEnd("underline",{parseDOM:[{tag:"u"},{style:"text-decoration=underline"}],toDOM:()=>["u",0]})),Qe.get("strikethrough")||(Qe=Qe.addToEnd("strikethrough",{parseDOM:[{tag:"s"},{tag:"del"},{style:"text-decoration=line-through"}],toDOM:()=>["s",0]}));const Ze=new B({nodes:Ge,marks:Qe});function Je(e){if(!e)return[];const t=[];return e.content.forEach(e=>{if(e.isText){const n=e.marks.map(e=>{const t=xe.marks[e.type.name];return t?t.create(e.attrs):null}).filter(e=>null!==e);t.push(xe.text(e.text||"",n))}else if("hard_break"===e.type.name){const e=xe.nodes.hard_break;e&&t.push(e.create())}else if("image"===e.type.name){const n=xe.nodes.image;n&&t.push(n.create(e.attrs))}}),t}function et(e){const t=function(){const e=new oe;return e.core.ruler.after("inline","task_list",e=>{const t=e.tokens;for(let n=0;n<t.length;n++){const e=t[n];if(e&&"list_item_open"===e.type){const o=t[n+2];if(o&&"inline"===o.type&&o.children){const t=o.children[0];if(t&&"text"===t.type&&t.content){const n=t.content.match(/^\[([ xX])\]\s*/);n&&n[1]&&(e.attrSet("checked","x"===n[1].toLowerCase()?"true":"false"),t.content=t.content.slice(n[0].length))}}}}return!0}),e.inline.ruler.before("html_inline","underline",(e,t)=>{const n=e.pos,o=e.posMax,r=e.src;if("<u>"!==r.slice(n,n+3).toLowerCase())return!1;const s="</u>",a=r.toLowerCase().indexOf(s,n+3);if(-1===a||a>=o)return!1;if(!t){e.push("underline_open","u",1).markup="<u>";const t=r.slice(n+3,a);e.push("text","",0).content=t,e.push("underline_close","u",-1).markup="</u>"}return e.pos=a+4,!0}),e}(),n=new ne(Ze,t,{blockquote:{block:"blockquote"},paragraph:{block:"paragraph"},list_item:{block:"list_item",getAttrs:e=>{const t=e.attrGet("checked");return"true"===t?{checked:!0}:"false"===t?{checked:!1}:{checked:null}}},bullet_list:{block:"bullet_list"},ordered_list:{block:"ordered_list",getAttrs:e=>({order:+(e.attrGet("start")||1)})},heading:{block:"heading",getAttrs:e=>({level:+e.tag.slice(1)})},code_block:{block:"code_block",noCloseToken:!0},fence:{block:"code_block",getAttrs:e=>({params:e.info||""}),noCloseToken:!0},hr:{node:"horizontal_rule"},em:{mark:"em"},strong:{mark:"strong"},underline:{mark:"underline"},s:{mark:"strikethrough"},link:{mark:"link",getAttrs:e=>({href:e.attrGet("href"),title:e.attrGet("title")||null})},code_inline:{mark:"code"},image:{node:"image",getAttrs:e=>({src:e.attrGet("src"),title:e.attrGet("title")||null,alt:e.content||null})},hardbreak:{node:"hard_break"}}).parse(e),o=[];var r,s;return r=o,s=0,n.forEach(e=>{if("bullet_list"===e.type.name||"ordered_list"===e.type.name)tt(e,r,s,e.type.name);else if("list_item"===e.type.name)nt(e,r,s,"bullet");else if("heading"===e.type.name){const t=Je(e),n=Te.block.create({type:"heading",level:e.attrs.level,indent:0},t);r.push(n)}else if("paragraph"===e.type.name){const t=Je(e),n=Te.block.create({type:"paragraph",indent:0},t);r.push(n)}else if("blockquote"===e.type.name)if(e.childCount>0)e.forEach(e=>{if("paragraph"===e.type.name){const t=Je(e),n=Te.block.create({type:"quote",indent:0},t);r.push(n)}});else{const t=Je(e),n=Te.block.create({type:"quote",indent:0},t);r.push(n)}else if("code_block"===e.type.name){const t=e.textContent,n=e.attrs.params||"",o=Te.block.create({type:"code",language:n||void 0,indent:0},xe.text(t));r.push(o)}else if("horizontal_rule"===e.type.name){const e=Te.divider.create({type:"divider",indent:0});r.push(e)}}),Te.doc.create(null,o)}function tt(e,t,n,o){let r=1;e.forEach(e=>{if("list_item"===e.type.name){const s="ordered_list"===o?r++:void 0;nt(e,t,n,"ordered_list"===o?"number":"bullet",s)}})}function nt(e,t,n,o,r){let s=null;e.forEach(e=>{"paragraph"===e.type.name&&(s=e)});const a=null!==e.attrs.checked,i=a?"task":o,l={type:i,indent:n,...a&&{checked:e.attrs.checked},..."number"===i&&"number"==typeof r&&{number:r}},d=s?Je(s):[],c=Te.block.create(l,d);t.push(c),e.forEach(e=>{"bullet_list"!==e.type.name&&"ordered_list"!==e.type.name||tt(e,t,n+1,e.type.name)})}function ot(e){return"bullet"===e||"number"===e||"task"===e}const rt="block-context-menu";class st{constructor(e,t,n){this.node=e,this.view=t,this.getPos=n,this.dom=document.createElement("div"),this.dom.className="block-row row-with-handle",this.updateDOMAttributes(),this.handleContainer=document.createElement("div"),this.handleContainer.className="block-handle-container",this.handleContainer.contentEditable="false",this.dom.appendChild(this.handleContainer),this.mountHandle();const{contentDOM:o,wrapperDOM:r}=this.createContentElement();this.contentDOM=o,this.dom.appendChild(r||o)}dom;contentDOM;handleDispose=null;handleContainer;createContentElement(){const{type:e,level:t,checked:n,language:o}=this.node.attrs;let r;switch(e){case"heading":{const e=`h${t||1}`;r=document.createElement(e);break}case"code":{const e=document.createElement("pre"),t=document.createElement("code");return e.appendChild(t),o&&(e.dataset.language=o),e.className="block-content",{contentDOM:t,wrapperDOM:e}}case"quote":r=document.createElement("blockquote");break;case"divider":r=document.createElement("hr");break;case"task":r=document.createElement("div"),r.className="block-task",r.dataset.checked=String(n||!1);break;case"bullet":case"number":r=document.createElement("div"),r.className=`block-${e}`,void 0!==this.node.attrs.number&&null!==this.node.attrs.number&&(r.dataset.number=String(this.node.attrs.number));break;default:r=document.createElement("p")}return r.className=`${r.className||""} block-content`.trim(),{contentDOM:r}}updateDOMAttributes(){const{type:e,indent:t,level:n,checked:o,language:r}=this.node.attrs;this.dom.dataset.type=e,this.dom.dataset.indent=String(t||0),null!=n&&(this.dom.dataset.level=String(n)),null!=o&&(this.dom.dataset.checked=String(o)),r&&(this.dom.dataset.language=r)}mountHandle(){const e=this.getPos(),t=void 0!==e?String(e):"0";this.handleDispose=a(()=>le({rowId:t,onDragStart:this.handleDragStart.bind(this),onContextMenu:this.handleContextMenu.bind(this),onClick:this.handleClick.bind(this)}),this.handleContainer)}handleDragStart(e,t){const n=this.getPos();if(void 0===n)return;const o=ze(this.view.state);if(o.length>1&&o.includes(n)?(e.dataTransfer?.setData("application/x-prosemirror-blocks",JSON.stringify(o)),e.dataTransfer&&(e.dataTransfer.effectAllowed="move"),this.view.dispatch(Ke(this.view.state.tr,{sourcePos:n,selectedPositions:o}))):(e.dataTransfer?.setData("application/x-prosemirror-block",String(n)),e.dataTransfer&&(e.dataTransfer.effectAllowed="move"),this.view.dispatch(Ke(this.view.state.tr,{sourcePos:n,selectedPositions:null}))),e.dataTransfer){const t=this.dom.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top;e.dataTransfer.setDragImage(this.dom,n,o)}this.dom.classList.add("dragging")}handleContextMenu(e,t){const n=this.getPos();if(void 0===n)return;const o=ze(this.view.state),r=o.length>1&&o.includes(n)?o.length:1,s={pos:n,x:e.clientX,y:e.clientY,selectedCount:r};this.view.dom.dispatchEvent(new CustomEvent(rt,{detail:s,bubbles:!0}))}handleClick(e,t){const n=this.getPos();if(void 0===n)return;const{state:o,dispatch:r}=this.view;if(!o.doc.nodeAt(n))return;if(e.shiftKey)return;const s=re.create(o.doc,n);r(o.tr.setSelection(s))}update(e){if(e.type!==this.node.type)return!1;if(e.attrs.type!==this.node.attrs.type)return!1;if(this.node=e,this.updateDOMAttributes(),"task"===e.attrs.type){const t=this.dom.querySelector(".block-task");t&&(t.dataset.checked=String(e.attrs.checked||!1))}return"number"===e.attrs.type&&void 0!==e.attrs.number&&null!==e.attrs.number&&(this.contentDOM.dataset.number=String(e.attrs.number)),!0}selectNode(){this.dom.classList.add("selected")}deselectNode(){this.dom.classList.remove("selected")}destroy(){this.dom.classList.remove("dragging"),this.handleDispose&&(this.handleDispose(),this.handleDispose=null)}ignoreMutation(e){return!("selection"===e.type||!this.handleContainer.contains(e.target))}}function at(e,t,n){return new st(e,t,n)}const it=new R("slashMenu"),lt={active:!1,query:"",triggerPos:0,position:{top:0,left:0}};function dt(e){e.dispatch(e.state.tr.setMeta(it,{close:!0}))}const ct=new R("dropUpload");function ut(e,t){const n=ct.getState(e.state);n?.isDragging!==t&&e.dispatch(e.state.tr.setMeta(ct,{isDragging:t}))}function pt(e){return"image/png"===e||"image/jpeg"===e||"image/gif"===e||"image/webp"===e||"image/svg+xml"===e||"image/avif"===e||"application/pdf"===e}const ht=/^\/w\/([^/+]+)(?:\+[^/]*)?\/([a-zA-Z0-9_-]+)(?:\+.*)?$/,gt=new R("invalidLink");function ft(e,t,n){const o=[];return e.descendants((e,r)=>{if(e.isText){const s=e.marks.find(e=>"link"===e.type.name);if(s&&s.attrs.href){(function(e,t,n){if(!n||!e)return!1;const o=e.match(ht);if(!o)return e.startsWith("/w/")&&console.warn("[invalidLink] Pattern did not match:",e),!1;const r=o[1],s=o[2];return r===n&&!!s&&!(s in t)})(s.attrs.href,t,n)&&o.push(G.inline(r,r+e.nodeSize,{class:"invalid-link"}))}}return!0}),X.create(e,o)}function kt(e,t,n){const o=e.state.tr.setMeta(gt,{linkedNodeTitles:t,wsId:n});e.dispatch(o)}const vt=new Set(["image/png","image/jpeg","image/gif","image/webp","image/svg+xml","image/avif","application/pdf"]);function mt(e){return e.startsWith("image/")}function bt(e,t,n){return(o,r)=>{const s=o.doc.nodeAt(e);if(!s)return!1;if(r){const a={...s.attrs,type:t,...n};"heading"!==t&&(a.level=void 0),"task"!==t&&(a.checked=void 0),"code"!==t&&(a.language=void 0),r(o.tr.setNodeMarkup(e,void 0,a))}return!0}}function yt(e,t,n){return(o,r)=>{if(0===e.length)return!1;let s=o.tr,a=!1;for(const i of e){const e=s.doc.nodeAt(i);if(!e)continue;const o={...e.attrs,type:t,...n};"heading"!==t&&(o.level=void 0),"task"!==t&&(o.checked=void 0),"code"!==t&&(o.language=void 0),s=s.setNodeMarkup(i,void 0,o),a=!0}return!!a&&(r&&r(s),!0)}}const wt="_container_c6w28_3";var $t=s("<div>");function St(o){const{t:s}=de(),[a,$]=i(null),S=e=>{const t=e,{pos:n,x:o,y:r,selectedCount:s}=t.detail;$({position:{x:o,y:r},blockPos:n,selectedCount:s})};l(()=>{const e=o.view;e&&e.dom.addEventListener(rt,S)}),d(()=>{const e=o.view;e&&e.dom.removeEventListener(rt,S)});const _=e=>{const t=o.view,n=a();if(!t||!n)return void $(null);const{blockPos:r}=n;switch(e){case"delete":(s=r,(e,t)=>{const n=e.doc.nodeAt(s);return!!n&&(t&&t(e.tr.delete(s,s+n.nodeSize)),!0)})(t.state,t.dispatch);break;case"duplicate":!function(e){return(t,n)=>{const o=t.doc.nodeAt(e);if(!o)return!1;if(n){const r=e+o.nodeSize;n(t.tr.insert(r,o.copy(o.content)))}return!0}}(r)(t.state,t.dispatch);break;case"indent":!function(e){return(t,n)=>{const o=t.doc.nodeAt(e);if(!o)return!1;const r=o.attrs.indent||0;return!(r>=8||(n&&n(t.tr.setNodeMarkup(e,void 0,{...o.attrs,indent:r+1})),0))}}(r)(t.state,t.dispatch);break;case"outdent":!function(e){return(t,n)=>{const o=t.doc.nodeAt(e);if(!o)return!1;const r=o.attrs.indent||0;return!(r<=0||(n&&n(t.tr.setNodeMarkup(e,void 0,{...o.attrs,indent:r-1})),0))}}(r)(t.state,t.dispatch);break;case"convert-paragraph":bt(r,"paragraph")(t.state,t.dispatch);break;case"convert-heading1":bt(r,"heading",{level:1})(t.state,t.dispatch);break;case"convert-heading2":bt(r,"heading",{level:2})(t.state,t.dispatch);break;case"convert-bullet":bt(r,"bullet")(t.state,t.dispatch);break;case"convert-number":bt(r,"number")(t.state,t.dispatch);break;case"convert-task":bt(r,"task",{checked:!1})(t.state,t.dispatch);break;case"convert-quote":bt(r,"quote")(t.state,t.dispatch);break;case"convert-code":bt(r,"code")(t.state,t.dispatch)}var s;$(null)},x=()=>{$(null)};return M=$t(),c(M,e(r,{get when(){return a()},children:t=>e(ce,{get position(){return t().position},get actions(){return(()=>{const t=a();if(!t)return[];const{selectedCount:n}=t,o=n>1,r=[{id:"duplicate",label:o?s("editor.duplicateBlocks")||`Duplicate ${n} blocks`:s("editor.duplicateBlock")||"Duplicate block",icon:e(u,{}),shortcut:"⌘D"}];return o||(r.push({id:"indent",label:s("editor.indent")||"Indent",icon:e(p,{}),shortcut:"Tab",separator:!0},{id:"outdent",label:s("editor.outdent")||"Outdent",icon:e(h,{}),shortcut:"⇧Tab"}),[{id:"convert-paragraph",type:"paragraph",label:s("editor.paragraph")||"Paragraph",icon:e(g,{})},{id:"convert-heading1",type:"heading",label:(s("editor.heading")||"Heading")+" 1",icon:e(f,{})},{id:"convert-heading2",type:"heading",label:(s("editor.heading")||"Heading")+" 2",icon:e(f,{})},{id:"convert-bullet",type:"bullet",label:s("editor.bulletList")||"Bullet list",icon:e(k,{})},{id:"convert-number",type:"number",label:s("editor.numberedList")||"Numbered list",icon:e(v,{})},{id:"convert-task",type:"task",label:s("editor.taskList")||"Task list",icon:e(m,{})},{id:"convert-quote",type:"quote",label:s("editor.blockquote")||"Quote",icon:e(b,{})},{id:"convert-code",type:"code",label:s("editor.codeBlock")||"Code block",icon:e(y,{})}].forEach((e,t)=>{r.push({id:e.id,label:e.label,icon:e.icon,separator:0===t})})),r.push({id:"delete",label:o?s("editor.deleteBlocks")||`Delete ${n} blocks`:s("editor.deleteBlock")||"Delete block",icon:e(w,{}),shortcut:"⌫",danger:!0,separator:!0}),r})()},onAction:_,onClose:x})})),t(()=>n(M,`${wt} ${o.class||""}`)),M;var M}var _t=s("<div style=position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:50>");function xt(t){const[n,o]=i(null),[r,s]=i(!1);return l(()=>{const e=t.view;if(!e)return;const n=e.dispatch.bind(e);e.dispatch=function(t){n(t);const r=He(e.state);(null!==r.sourcePos||r.selectedPositions&&r.selectedPositions.length>0)&&null!==r.dropIndicatorY?(o(r.dropIndicatorY),s(!0)):s(!1)},d(()=>{e.dispatch=n})}),$(()=>{t.view||s(!1)}),a=_t(),c(a,e(me,{get y(){return n()??0},get visible(){return r()}})),a;var a}function Mt(e,t,n,o){const r=e.state.tr.delete(t,n);e.dispatch(r),o(e)}function Ct(e,t,n={}){const{state:o,dispatch:r}=e,{$from:s}=o.selection;for(let a=s.depth;a>0;a--){if(s.node(a).isBlock)return void bt(s.before(a),t,n)(o,r)}}const Tt=[{id:"paragraph",labelKey:"paragraph",keywords:["paragraph","text","plain"],icon:g,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"paragraph")})}},{id:"heading1",labelKey:"heading1",keywords:["heading","h1","title","header"],icon:f,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"heading",{level:1})})}},{id:"heading2",labelKey:"heading2",keywords:["heading","h2","subtitle","header"],icon:f,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"heading",{level:2})})}},{id:"heading3",labelKey:"heading3",keywords:["heading","h3","header"],icon:f,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"heading",{level:3})})}},{id:"bulletList",labelKey:"bulletList",keywords:["bullet","list","unordered","ul"],icon:k,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"bullet")})}},{id:"orderedList",labelKey:"orderedList",keywords:["ordered","list","numbered","ol"],icon:v,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"number")})}},{id:"taskList",labelKey:"taskList",keywords:["task","checkbox","todo","checklist","check"],icon:m,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"task",{checked:!1})})}},{id:"blockquote",labelKey:"blockquote",keywords:["quote","blockquote","citation"],icon:b,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"quote")})}},{id:"codeBlock",labelKey:"codeBlock",keywords:["code","codeblock","pre","programming"],icon:y,execute:(e,t,n)=>{Mt(e,t,n,e=>{Ct(e,"code")})}},{id:"divider",labelKey:"divider",keywords:["divider","hr","horizontal","rule","line"],icon:S,execute:e=>{Ct(e,"divider");const{state:t}=e,{$from:n}=t.selection,o=n.before(1),r=t.doc.nodeAt(o);if(r){const n=o+r.nodeSize,s=t.tr.insert(n,Te.block.create({type:"paragraph",indent:r.attrs.indent}));s.setSelection(se.near(s.doc.resolve(n+1))),e.dispatch(s)}}},{id:"subpage",labelKey:"subpage",keywords:["subpage","page","child","nested","link"],icon:_,asyncAction:"createSubpage",execute:()=>{}}];function Dt(e,t){const n=t.toLowerCase();return n===e?100:n.startsWith(e)?90:n.includes(e)?70:function(e,t){let n=0;for(let o=0;o<t.length&&n<e.length;o++)t[o]===e[n]&&n++;return n===e.length}(e,n)?50:0}function Et(e,t){if(!e)return Tt;const n=e.toLowerCase(),o=Tt.map(e=>{let o=0;o=Math.max(o,Dt(n,e.labelKey));for(const t of e.keywords)o=Math.max(o,Dt(n,t));if(t){const r=t(`slashMenu.${e.labelKey}`);r&&(o=Math.max(o,Dt(n,r)))}return{cmd:e,score:o}}).filter(e=>e.score>0);return o.sort((e,t)=>t.score-e.score),o.map(e=>e.cmd)}const qt="_editorContainer_17qe7_3",At="_floatingToolbar_17qe7_13",Lt="_above_17qe7_32",It="_toolbarRow_17qe7_38",Pt="_formatButton_17qe7_45",Nt="_isActive_17qe7_68",Ot="_separator_17qe7_73",Bt="_modeIndicator_17qe7_81",zt="_modeIndicatorActive_17qe7_115",Kt="_prosemirrorEditor_17qe7_122",Ht="_markdownEditor_17qe7_376",Ut="_hidden_17qe7_396",jt="_slashMenu_17qe7_401",Ft="_slashMenuItem_17qe7_415",Wt="_selected_17qe7_425",Yt="_slashMenuIcon_17qe7_429",Rt="_slashMenuLabel_17qe7_445",Xt="_slashMenuEmpty_17qe7_450";var Gt=s("<div data-testid=slash-command-menu>"),Vt=s("<div>"),Qt=s("<div><span></span><span>");function Zt(s){const{t:a}=de(),u=x(),{user:p,wsApi:h}=ue(),{loadNode:g,fetchNodeChildren:f}=pe(),{flushAutoSave:k}=he(),[v,m]=i(0),[b,y]=i(null);let w;const S=()=>Et(s.state.query,a);$(()=>{s.state.query,s.state.active,m(0),y(null)}),$(()=>{s.state.active&&w&&requestAnimationFrame(()=>{if(!w)return;const e=w.getBoundingClientRect(),t=window.innerHeight,n=window.innerWidth;let o=s.state.position.top,r=s.state.position.left;if(0===o&&0===r)try{const e=s.view.coordsAtPos(s.state.triggerPos);o=e.bottom+4,r=e.left}catch{}if(o+e.height>t){o=s.view.coordsAtPos(s.state.triggerPos).top-e.height-4,o<0&&(o=8)}r+e.width>n&&(r=n-e.width-8),r<0&&(r=8),o===s.state.position.top&&r===s.state.position.left||y({top:o,left:r})})}),$(()=>{const e=v();if(w){const t=w.querySelector(`[data-index="${e}"]`);t&&t.scrollIntoView({block:"nearest"})}}),ge(()=>w,()=>{s.state.active&&dt(s.view)}),l(()=>{const e=e=>{const t=it.getState(s.view.state);if(!t?.active)return;const n=Et(t.query,a);if(0!==n.length)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),m(e=>(e+1)%n.length);break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),m(e=>(e-1+n.length)%n.length);break;case"Enter":case"Tab":e.preventDefault(),e.stopPropagation(),_(n[v()]);break;case"Escape":e.preventDefault(),e.stopPropagation(),dt(s.view)}};document.addEventListener("keydown",e,!0),d(()=>{document.removeEventListener("keydown",e,!0)})});const _=async e=>{if(!e)return;const t=it.getState(s.view.state);if(!t)return;const{triggerPos:n}=t,o=s.view.state.selection.from;if("createSubpage"===e.asyncAction){const e=h(),t=p(),i=s.nodeId;if(!e||!t||!i)return;const l=s.view.state.tr.delete(n,o);s.view.dispatch(l);try{const n=a("slashMenu.untitledSubpage")||"Untitled",o=await e.nodes.page.createPage(i,{title:n});if(!o?.id)return;const r=t.workspace_id,l=t.workspace_name,d=fe(r||"",l,o.id,n),c=De.link.create({href:d,title:null}),p=xe.text(n,[c]),h=s.view.state.tr.insert(s.view.state.selection.from,p);s.view.dispatch(h),k(),await f(i),await g(o.id),u(d)}catch(r){console.error("Failed to create subpage:",r)}return void s.view.focus()}e.execute(s.view,n,o),s.view.focus()},D=()=>b()??s.state.position;return e(r,{get when(){return s.state.active},get children(){var s=Gt();return"function"==typeof w?M(w,s):w=s,c(s,e(r,{get when(){return S().length>0},get fallback(){return e=Vt(),c(e,()=>a("slashMenu.noResults")),t(()=>n(e,Xt)),e;var e},get children(){return e(C,{get each(){return S()},children:(o,r)=>{return s=Qt(),i=s.firstChild,l=i.nextSibling,s.addEventListener("mouseenter",()=>(e=>{m(e)})(r())),s.$$click=()=>(e=>{_(e)})(o),c(i,e(o.icon,{})),c(l,()=>a(`slashMenu.${o.labelKey}`)),t(e=>{var t=`${Ft} ${r()===v()?Wt:""}`,o=r(),a=Yt,d=Rt;return t!==e.e&&n(s,e.e=t),o!==e.t&&T(s,"data-index",e.t=o),a!==e.a&&n(i,e.a=a),d!==e.o&&n(l,e.o=d),e},{e:void 0,t:void 0,a:void 0,o:void 0}),s;var s,i,l}})}})),t(e=>{var t=jt,r=`${D().top}px`,a=`${D().left}px`,i=(()=>{const e=D();return 0!==e.top||0!==e.left})()?"visible":"hidden";return t!==e.e&&n(s,e.e=t),r!==e.t&&o(s,"top",e.t=r),a!==e.a&&o(s,"left",e.a=a),i!==e.o&&o(s,"visibility",e.o=i),e},{e:void 0,t:void 0,a:void 0,o:void 0}),s}})}D(["click"]);var Jt=s('<div data-testid=floating-toolbar><div><button title="Bold (Ctrl+B)"></button><button title="Italic (Ctrl+I)"></button><button title="Underline (Ctrl+U)"></button><button title="Strikethrough (Ctrl+Shift+X)"></button><button title="Code (Ctrl+`)"></button></div><div><button title="Heading 1">H1</button><button title="Heading 2">H2</button><button title="Heading 3">H3</button><span></span><button title="Bullet List"></button><button title="Numbered List"></button><button title="Task List"></button><button title=Quote></button><button title="Code Block">');function en(s){let a;const[l,d]=i(!1),[u,p]=i(null);$(E(()=>s.position,()=>{if(!s.position||!a)return d(!1),void p(null);requestAnimationFrame(()=>{if(!a||!s.position)return;const e=a.getBoundingClientRect(),t=s.position.bottom+e.height+8>window.innerHeight;d(t);const n=e.width/2,o=s.editorElement?.getBoundingClientRect(),r=(o?.left??0)+n,i=(o?.right??window.innerWidth)-n,l=s.position.left;p(l<r?r:l>i?i:null)})}));const h=e=>e?`${Pt} ${Nt}`:Pt,g=()=>{s.view&&(ae(De.strong)(s.view.state,s.view.dispatch),s.view.focus())},f=()=>{s.view&&(ae(De.em)(s.view.state,s.view.dispatch),s.view.focus())},w=()=>{s.view&&(ae(De.underline)(s.view.state,s.view.dispatch),s.view.focus())},S=()=>{s.view&&(ae(De.strikethrough)(s.view.state,s.view.dispatch),s.view.focus())},_=()=>{s.view&&(ae(De.code)(s.view.state,s.view.dispatch),s.view.focus())},x=(e,t={})=>{if(!s.view)return;const{state:n,dispatch:o}=s.view,r=ze(n);if(0===r.length){const{$from:r}=n.selection;for(let s=r.depth;s>0;s--)if(r.node(s).isBlock){yt([r.before(s)],e,t)(n,o);break}}else yt(r,e,t)(n,o);s.view.focus()},C=e=>{s.formatState.headingLevel===e?x("paragraph"):x("heading",{level:e})},T=()=>{s.formatState.isBulletList?x("paragraph"):x("bullet")},D=()=>{s.formatState.isOrderedList?x("paragraph"):x("number")},N=()=>{s.formatState.isTaskList?x("paragraph"):x("task",{checked:!1})},O=()=>{s.formatState.isBlockquote?x("paragraph"):x("quote")},B=()=>{s.formatState.isCodeBlock?x("paragraph"):x("code")};return e(r,{get when(){return s.position},get children(){var r=Jt(),i=r.firstChild,d=i.firstChild,p=d.nextSibling,$=p.nextSibling,x=$.nextSibling,E=x.nextSibling,z=i.nextSibling,K=z.firstChild,H=K.nextSibling,U=H.nextSibling,j=U.nextSibling,F=j.nextSibling,W=F.nextSibling,Y=W.nextSibling,R=Y.nextSibling,X=R.nextSibling;return"function"==typeof a?M(a,r):a=r,d.$$click=g,c(d,e(q,{})),p.$$click=f,c(p,e(A,{})),$.$$click=w,c($,e(L,{})),x.$$click=S,c(x,e(I,{})),E.$$click=_,c(E,e(y,{})),K.$$click=()=>C(1),H.$$click=()=>C(2),U.$$click=()=>C(3),F.$$click=T,c(F,e(k,{})),W.$$click=D,c(W,e(v,{})),Y.$$click=N,c(Y,e(m,{})),R.$$click=O,c(R,e(b,{})),X.$$click=B,c(X,e(P,{})),t(e=>{var t=`${At} ${l()?Lt:""}`,a=`${l()?s.position?.top:s.position?.bottom}px`,c=`${u()??s.position?.left??0}px`,g=It,f=h(s.formatState.isBold),k=h(s.formatState.isItalic),v=h(s.formatState.isUnderline),m=h(s.formatState.isStrikethrough),b=h(s.formatState.isCode),y=It,w=h(1===s.formatState.headingLevel),S=h(2===s.formatState.headingLevel),_=h(3===s.formatState.headingLevel),M=Ot,C=h(s.formatState.isBulletList),T=h(s.formatState.isOrderedList),D=h(s.formatState.isTaskList),q=h(s.formatState.isBlockquote),A=h(s.formatState.isCodeBlock);return t!==e.e&&n(r,e.e=t),a!==e.t&&o(r,"top",e.t=a),c!==e.a&&o(r,"left",e.a=c),g!==e.o&&n(i,e.o=g),f!==e.i&&n(d,e.i=f),k!==e.n&&n(p,e.n=k),v!==e.s&&n($,e.s=v),m!==e.h&&n(x,e.h=m),b!==e.r&&n(E,e.r=b),y!==e.d&&n(z,e.d=y),w!==e.l&&n(K,e.l=w),S!==e.u&&n(H,e.u=S),_!==e.c&&n(U,e.c=_),M!==e.w&&n(j,e.w=M),C!==e.m&&n(F,e.m=C),T!==e.f&&n(W,e.f=T),D!==e.y&&n(Y,e.y=D),q!==e.g&&n(R,e.g=q),A!==e.p&&n(X,e.p=A),e},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0,w:void 0,m:void 0,f:void 0,y:void 0,g:void 0,p:void 0}),r}})}D(["click"]);var tn=s('<div><div data-testid=wysiwyg-editor></div><textarea data-testid=markdown-editor></textarea><div><button title="Visual mode (Ctrl+Shift+M)"data-testid=editor-mode-visual>Visual</button><button title="Markdown mode (Ctrl+Shift+M)"data-testid=editor-mode-markdown>MD');function nn(o){const{t:s}=de(),[a,u]=i("wysiwyg"),[p,h]=i(N(()=>o.content)),[g,f]=i(),[k,v]=i({active:!1,query:"",triggerPos:0,position:{top:0,left:0}}),[m,b]=i(),y=(w=v,new Y({key:it,state:{init:()=>({...lt}),apply(e,t,n,o){const r=e.getMeta(it);if(r?.close){if(t.active){const e={...lt};return setTimeout(()=>w(e),0),e}return t}if(!e.docChanged&&!e.selectionSet)return t;const{selection:s}=o,{$from:a}=s;if(!s.empty){if(t.active){const e={...lt};return setTimeout(()=>w(e),0),e}return t}const i=a.start(a.depth);if(!a.parent.isTextblock)return t;const l=o.doc.textBetween(i,a.pos,"",""),d=l.match(/(^|\s)\/([^\s]*)$/);if(d){const e=d[2]||"",n={active:!0,query:e,triggerPos:i+(l.length-d[0].length+(d[1]?1:0)),position:t.position};return t.active&&e!==t.query&&setTimeout(()=>w(n),0),n}if(t.active){const e={...lt};return setTimeout(()=>w(e),0),e}return t}},view:e=>({update(e){const t=it.getState(e.state);if(t?.active)try{const n=e.coordsAtPos(t.triggerPos),o=n.bottom+4,r=n.left,s=o>0||r>0?{top:o,left:r}:t.position,a={...t,position:s};w(a)}catch{w(t)}}}),props:{handleKeyDown(e,t){const n=it.getState(e.state);return!!n?.active&&("ArrowDown"===t.key||"ArrowUp"===t.key||"Enter"===t.key||"Tab"===t.key||"Escape"===t.key&&(dt(e),!0))}}}));var w;const S=new Y({key:gt,state:{init:()=>({decorations:X.empty,linkedNodeTitles:{},wsId:void 0}),apply(e,t,n,o){const r=e.getMeta(gt);if(r){const e=r.linkedNodeTitles??t.linkedNodeTitles,n=r.wsId??t.wsId;return{decorations:ft(o.doc,e,n),linkedNodeTitles:e,wsId:n}}return e.docChanged?{...t,decorations:ft(o.doc,t.linkedNodeTitles,t.wsId)}:{...t,decorations:t.decorations.map(e.mapping,e.doc)}}},props:{decorations:e=>gt.getState(e)?.decorations??X.empty}}),_=(x={onFileDrop:async(e,t)=>{const n=g();if(!(n&&o.wsId&&o.nodeId&&o.getToken))return;const{uploadFile:r,error:s}=function(e){const[t,n]=i(!1),[o,r]=i(null);return{uploadFile:async t=>{if(r(null),t.size>10485760){const e=`File too large: ${t.name} (max 10MB)`;return r(e),console.error(e),null}if(!vt.has(t.type)){const e=`Unsupported file type: ${t.type}`;return r(e),console.error(e),null}const o=e.getToken();if(!o){const e="Not authenticated";return r(e),console.error(e),null}n(!0);try{const n=new FormData;n.append("file",t);const r=await fetch(`/api/v1/workspaces/${e.wsId}/nodes/${e.nodeId}/assets`,{method:"POST",headers:{Authorization:`Bearer ${o}`},body:n});if(!r.ok){const e=await r.text();throw new Error(`Upload failed: ${r.status} ${e}`)}const s=await r.json();return{name:s.name,mimeType:s.mime_type,url:s.url}}catch(s){const e=s instanceof Error?s.message:String(s);return r(e),console.error("Asset upload failed:",s),null}finally{n(!1)}},uploading:t,error:o}}({wsId:o.wsId,nodeId:o.nodeId,getToken:o.getToken});for(const a of e){const e=await r(a);if(e){const r=mt(e.mimeType);let s=n.state.tr;if(r){const n=xe.nodes.image;if(n){const o=n.create({src:e.url,alt:e.name,title:null}),r=Te.block.create({type:"paragraph",indent:0},o);s=s.insert(t,r)}}else{const n=De.link;if(n){const o=n.create({href:e.url,title:null}),r=xe.text(e.name,[o]),a=Te.block.create({type:"paragraph",indent:0},r);s=s.insert(t,a)}}n.dispatch(s),o.onAssetUploaded?.()}else{const e=s();e&&o.onError?.(e)}}}},new Y({key:ct,state:{init:()=>({isDragging:!1}),apply(e,t){const n=e.getMeta(ct);return void 0!==n?{isDragging:n.isDragging}:t}},props:{attributes(e){const t=ct.getState(e);return t?.isDragging?{class:"drop-target-active"}:{}},handleDOMEvents:{dragenter:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),ut(e,!0),!1),dragover:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),!1),dragleave(e,t){const n=t.relatedTarget,o=e.dom;return n&&o.contains(n)||ut(e,!1),!1},drop(e,t){ut(e,!1);const n=t.dataTransfer?.files;if(!n||0===n.length)return!1;const o=[];for(const s of n)pt(s.type)&&o.push(s);if(0===o.length)return!1;t.preventDefault();const r=e.posAtCoords({left:t.clientX,top:t.clientY});return r?(x.onFileDrop(o,r.pos),!0):(x.onFileDrop(o,e.state.doc.content.size),!0)}}}}));var x;let C=N(()=>o.nodeId),D=N(()=>o.content),q=N(()=>o.linkedNodeTitles);const[A,L]=i({isBold:!1,isItalic:!1,isUnderline:!1,isStrikethrough:!1,isCode:!1,headingLevel:null,isBulletList:!1,isOrderedList:!1,isTaskList:!1,isBlockquote:!1,isCodeBlock:!1}),[I,P]=i(null),B=e=>{let t=function(e,t){if(!t||0===Object.keys(t).length)return e;let n=e.replace(/!\[([^\]]*)\]\(([^/)][^)]*)\)/g,(e,n,o)=>{if(!be(o))return e;const r=t[o];return r?`![${n}](${r})`:e});return n=n.replace(/\[([^\]]+)\]\(([^/)][^)]*)\)/g,(e,n,o)=>{if(!be(o))return e;const r=t[o];return r?`[${n}](${r})`:e}),n}(e,o.assetUrls||{});var n,r,s;return o.wsId&&o.linkedNodeTitles&&Object.keys(o.linkedNodeTitles).length>0&&(n=t,r=o.linkedNodeTitles,s=o.wsId,t=n&&s&&r&&0!==Object.keys(r).length?n.replace(/\[([^\]]*)\]\((\/w\/([^/+]+)(?:\+[^/]*)?\/([A-Za-z0-9]+)(?:\+[^)]*)?)\)/g,(e,t,n,o,a)=>{if(o!==s)return e;const i=r[a];return void 0!==i?`[${i}](${n})`:e}):n),et(t)},z=e=>{const t=function(e){const t=[],n=[],o=new Map;let r=null;return e.forEach(e=>{const{type:s,indent:a,checked:i,level:l,language:d}=e.attrs,c=function(e){let t="";return e.forEach(e=>{if(e.isText){let n=e.text||"";e.marks.forEach(e=>{if("strong"===e.type.name)n=`**${n}**`;else if("em"===e.type.name)n=`*${n}*`;else if("code"===e.type.name)n=`\`${n}\``;else if("strikethrough"===e.type.name)n=`~~${n}~~`;else if("underline"===e.type.name)n=`<u>${n}</u>`;else if("link"===e.type.name){const t=e.attrs.href||"#",o=e.attrs.title;n=`[${n}](${t}${o?` "${o}"`:""})`}}),t+=n}else if("image"===e.type.name){const{src:n,alt:o,title:r}=e.attrs;t+=`![${o||""}](${n||""}${r?` "${r}"`:""})`}else"hard_break"===e.type.name&&(t+="\\\n")}),t}(e);for(;n.length>0;){const e=n[n.length-1];if(void 0===e)break;if(!(e.indent>a||e.indent===a&&e.type!==s&&ot(s)))break;n.pop()}const u="bullet"===r||"number"===r||"task"===r,p="paragraph"===s;t.length>0&&u&&p&&t.push(""),t.length>0&&"paragraph"===r&&p&&t.push(""),t.length>0&&"paragraph"===r&&ot(s)&&t.push("");const h="  ".repeat(a);let g="";switch(s){case"bullet":g="- ",n.some(e=>e.indent===a&&"bullet"===e.type)||n.push({type:"bullet",indent:a});break;case"number":{const e=(o.get(a)||0)+1;o.set(a,e),g=`${e}. `,n.some(e=>e.indent===a&&"number"===e.type)||n.push({type:"number",indent:a});break}case"task":g=i?"- [x] ":"- [ ] ",n.some(e=>e.indent===a&&"task"===e.type)||n.push({type:"task",indent:a});break;case"heading":g="#".repeat(l||1)+" ",o.delete(a);break;case"quote":g="> ",o.delete(a);break;case"code":return t.push("```"+(d||"")),t.push(c),t.push("```"),void(r=s);case"divider":return t.push("---"),void(r=s);default:g="",o.delete(a)}t.push(h+g+c),r=s}),t.join("\n")}(e);return $e(t,o.assetUrls||{})},K=e=>{const{state:t}=e,{from:n,$from:o,to:r,empty:s}=t.selection;if(s||"markdown"===a())P(null);else try{const t=e.coordsAtPos(n),o=e.coordsAtPos(r),s=Math.abs(t.top-o.top)<20;let a=t.left;a=s?(t.left+o.right)/2:t.left+40,P({top:t.top,bottom:o.bottom,left:a})}catch{P(null)}const i=s?t.storedMarks||o.marks():[],l=void 0!==De.strong.isInSet(i)||t.doc.rangeHasMark(n,r,De.strong),d=void 0!==De.em.isInSet(i)||t.doc.rangeHasMark(n,r,De.em),c=void 0!==De.underline.isInSet(i)||t.doc.rangeHasMark(n,r,De.underline),u=void 0!==De.strikethrough.isInSet(i)||t.doc.rangeHasMark(n,r,De.strikethrough),p=void 0!==De.code.isInSet(i)||t.doc.rangeHasMark(n,r,De.code);let h=null;o.depth>=1&&(h=o.node(1)),h||0!==n||(h=t.doc.nodeAt(0));let g=!1,f=!1,k=!1,v=!1,m=!1,b=null;if(h&&"block"===h.type.name){const e=h.attrs.type;"bullet"===e&&(g=!0),"number"===e&&(f=!0),"task"===e&&(k=!0),"quote"===e&&(v=!0),"code"===e&&(m=!0),"heading"===e&&(b=h.attrs.level)}L({isBold:l,isItalic:d,isUnderline:c,isStrikethrough:u,isCode:p,headingLevel:b,isBulletList:g,isOrderedList:f,isTaskList:k,isBlockquote:v,isCodeBlock:m})};l(()=>{const e=m();if(!e)return;const t=B(o.content);if(!t)return;const n=Xe(t,[y,_,S]),r=new ie(e,{state:n,editable:()=>!o.readOnly,nodeViews:{block:at},dispatchTransaction(e){const t=r.state.apply(e);if(r.updateState(t),e.docChanged){const e=z(t.doc);h(e),D=e,o.onChange(e)}K(r)},handleDOMEvents:{click:(e,t)=>{const n=t.target.closest("a");if(!n)return!1;const r=n.getAttribute("href");if(!r)return!1;const s=r.match(ht);return s&&s[2]&&o.onNavigateToNode?(t.preventDefault(),o.onNavigateToNode(s[2]),!0):!(!r.startsWith("http://")&&!r.startsWith("https://"))&&(t.preventDefault(),window.open(r,"_blank","noopener,noreferrer"),!0)}}}),s=e.querySelector(".ProseMirror");s&&(s.pmView=r),f(r),K(r),kt(r,o.linkedNodeTitles||{},o.wsId);const a=()=>K(r),i=e.closest('[class*="prosemirrorEditor"]')||e;i.addEventListener("scroll",a,{passive:!0}),window.addEventListener("scroll",a,{passive:!0}),d(()=>{r.destroy(),i.removeEventListener("scroll",a),window.removeEventListener("scroll",a)})}),$(E(()=>[o.nodeId,o.content,o.linkedNodeTitles],([e,t,n])=>{const r=e!==C,s=t!==D;if(r||s||n!==q){C=e,D=t,q=n,(r||s)&&(h(t),u("wysiwyg"));const a=g();if(a){const e=B(t);if(e){const t=Xe(e,[y,_,S]);a.updateState(t),kt(a,n||{},o.wsId)}}}},{defer:!0}));const H=()=>{const e=g();if(e){const t=B(p());if(t){const n=Xe(t,[y,_,S]);e.updateState(n),K(e),kt(e,o.linkedNodeTitles||{},o.wsId)}}u("wysiwyg")},U=()=>{const e=g();if(e){const t=z(e.state.doc);h(t)}u("markdown")},j=e=>{e.ctrlKey&&e.shiftKey&&"m"===e.key.toLowerCase()&&(e.preventDefault(),"wysiwyg"===a()?U():H())};l(()=>{document.addEventListener("keydown",j)}),d(()=>{document.removeEventListener("keydown",j)});const F=O(()=>"wysiwyg"===a()?Kt:`${Kt} ${Ut}`),W=O(()=>"markdown"===a()?Ht:`${Ht} ${Ut}`);return R=tn(),G=R.firstChild,V=G.nextSibling,Q=V.nextSibling,Z=Q.firstChild,J=Z.nextSibling,c(R,e(en,{get formatState(){return A()},get view(){return g()},get position(){return I()},get editorElement(){return m()}}),G),c(R,e(St,{get view(){return g()}}),G),c(R,e(xt,{get view(){return g()}}),G),M(b,G),V.$$input=e=>{return t=e.target.value,h(t),D=t,void o.onChange(t);var t},Z.$$click=H,J.$$click=U,c(R,e(r,{get when(){return g()},children:t=>e(Zt,{get view(){return t()},get state(){return k()},get nodeId(){return o.nodeId}})}),null),t(e=>{var t=qt,r=F(),i=W(),l=o.placeholder||s("editor.contentPlaceholder")||"Write markdown...",d=o.readOnly,c=Bt,u="wysiwyg"===a()?zt:void 0,p="markdown"===a()?zt:void 0;return t!==e.e&&n(R,e.e=t),r!==e.t&&n(G,e.t=r),i!==e.a&&n(V,e.a=i),l!==e.o&&T(V,"placeholder",e.o=l),d!==e.i&&(V.readOnly=e.i=d),c!==e.n&&n(Q,e.n=c),u!==e.s&&n(Z,e.s=u),p!==e.h&&n(J,e.h=p),e},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),t(()=>V.value=p()),R;var R,G,V,Q,Z,J}D(["input","click"]);export{nn as default};
