import{c as e,j as t,o,D as i,e as s,S as n,z as r,l as a,F as l,m as c,n as d,q as u,s as p,x as f,h,w as g,d as m}from"./vendor-g8mwYROu.js";import{S as k,M as v,E as b,k as w,h as y,d as _,g as S,s as $,a as x,b as L,w as M,t as C,i as T,P as B,D as I,c as D,e as q,f as E,j as A,l as z,I as P,u as N,r as O,m as K,n as U,o as H,p as F,q as j,v as W,x as G,y as V,z as R,A as X,B as Q,T as Y,C as J,F as Z}from"./editor-vendor-B020UQdt.js";import{u as ee,a as te,b as oe,c as ie,d as se,n as ne,r as re,e as ae,f as le}from"./index-PhX4429G.js";const ce=$.spec.nodes.get("list_item");if(!ce)throw new Error("list_item node not found in schema");const de=new k({nodes:$.spec.nodes.update("list_item",{...ce,attrs:{checked:{default:null}},toDOM:e=>null!==e.attrs.checked?["li",{class:"task-list-item","data-checked":String(e.attrs.checked)},0]:["li",0],parseDOM:[{tag:"li",getAttrs:e=>e.classList.contains("task-list-item")?{checked:"true"===e.dataset.checked}:{checked:null}}]}),marks:$.spec.marks.addToEnd("underline",{parseDOM:[{tag:"u"},{style:"text-decoration=underline"}],toDOM:()=>["u",0]})});function ue(e){const t=de.nodes[e];if(!t)throw new Error(`Node type '${e}' not found in schema`);return t}function pe(e){const t=de.marks[e];if(!t)throw new Error(`Mark type '${e}' not found in schema`);return t}const fe={doc:ue("doc"),list_item:ue("list_item"),bullet_list:ue("bullet_list"),ordered_list:ue("ordered_list"),paragraph:ue("paragraph"),blockquote:ue("blockquote"),code_block:ue("code_block"),heading:ue("heading")},he={strong:pe("strong"),em:pe("em"),code:pe("code"),link:pe("link"),underline:pe("underline")},ge=new x;ge.inline.ruler.before("html_inline","underline",(e,t)=>{const o=e.pos,i=e.posMax,s=e.src;if("<u>"!==s.slice(o,o+3).toLowerCase())return!1;const n="</u>",r=s.toLowerCase().indexOf(n,o+3);if(-1===r||r>=i)return!1;if(!t){e.push("underline_open","u",1).markup="<u>";const t=s.slice(o+3,r);e.push("text","",0).content=t;e.push("underline_close","u",-1).markup="</u>"}return e.pos=r+4,!0}),ge.core.ruler.after("inline","task_list",e=>{const t=e.tokens;for(let o=0;o<t.length;o++){const e=t[o];if(e&&"list_item_open"===e.type){const i=t[o+2];if(i&&"inline"===i.type&&i.children){const t=i.children[0];if(t&&"text"===t.type&&t.content){const o=t.content.match(/^\[([ xX])\]\s*/);o&&o[1]&&(e.attrSet("checked","x"===o[1].toLowerCase()?"true":"false"),t.content=t.content.slice(o[0].length))}}}}return!0});const me=new v(de,ge,{blockquote:{block:"blockquote"},paragraph:{block:"paragraph"},list_item:{block:"list_item",getAttrs:e=>{const t=e.attrGet("checked");return"true"===t?{checked:!0}:"false"===t?{checked:!1}:{checked:null}}},bullet_list:{block:"bullet_list"},ordered_list:{block:"ordered_list",getAttrs:e=>({order:+(e.attrGet("start")||1)})},heading:{block:"heading",getAttrs:e=>({level:+e.tag.slice(1)})},code_block:{block:"code_block",noCloseToken:!0},fence:{block:"code_block",getAttrs:e=>({params:e.info||""}),noCloseToken:!0},hr:{node:"horizontal_rule"},image:{node:"image",getAttrs:e=>({src:e.attrGet("src"),title:e.attrGet("title")||null,alt:e.children?.[0]?.content||null})},hardbreak:{node:"hard_break"},em:{mark:"em"},strong:{mark:"strong"},underline:{mark:"underline"},link:{mark:"link",getAttrs:e=>({href:e.attrGet("href"),title:e.attrGet("title")||null})},code_inline:{mark:"code"},table:{block:"paragraph",noCloseToken:!1},thead:{ignore:!0},tbody:{ignore:!0},tr:{ignore:!0},th:{block:"paragraph"},td:{block:"paragraph"}}),ke=new L({...q.nodes,bullet_list(e,t){e.renderList(t,"  ",()=>"- ")},list_item(e,t){if(null!==t.attrs.checked){const o=t.attrs.checked?"[x] ":"[ ] ";e.write(o)}e.renderContent(t)}},{...q.marks,underline:{open:"<u>",close:"</u>",mixable:!0,expelEnclosingWhitespace:!0}});function ve(){const e=E.concat(A,z);e.push(new P(/^\s*-\s+\[([ xX])\]\s$/,(e,t,o,i)=>{const s=e.doc.resolve(o),n="x"===t[1]?.toLowerCase();for(let l=s.depth;l>0;l--)if(s.node(l).type===fe.list_item){const t=e.tr.delete(o,i);return t.setNodeMarkup(s.before(l),void 0,{checked:n}),t}const r=fe.list_item.create({checked:n},fe.paragraph.create()),a=fe.bullet_list.create(null,r);return e.tr.replaceWith(o,i,a)})),e.push(M(/^\s*>\s$/,fe.blockquote)),e.push(M(/^\s*([-*])\s$/,fe.bullet_list)),e.push(M(/^(\d+)\.\s$/,fe.ordered_list,e=>({order:+(e[1]??1)}),(e,t)=>t.childCount+t.attrs.order===+(e[1]??1))),e.push(C(/^```$/,fe.code_block));for(let t=1;t<=6;t++){const o=new RegExp(`^(#{${t}})\\s$`);e.push(C(o,fe.heading,{level:t}))}return T({rules:e})}function be(){const e={};return e["Mod-z"]=N,e["Mod-y"]=O,e["Mod-Shift-z"]=O,e["Mod-b"]=K(he.strong),e["Mod-i"]=K(he.em),e["Mod-u"]=K(he.underline),e["Mod-`"]=K(he.code),e.Enter=(e,t)=>{const{$from:o}=e.selection;for(let i=o.depth;i>0;i--){const s=o.node(i);if(s.type===fe.list_item&&null!==s.attrs.checked){if(t){return U(fe.list_item)(e,e=>{const o=e.selection.$from;for(let t=o.depth;t>0;t--){if(o.node(t).type===fe.list_item){e.setNodeMarkup(o.before(t),void 0,{checked:!1});break}}t(e)})}return U(fe.list_item)(e)}}return U(fe.list_item)(e,t)},e.Tab=H(fe.list_item),e["Shift-Tab"]=F(fe.list_item),w(e)}function we(e,t){return b.create({doc:e,plugins:[ve(),be(),w(j),y(),_({color:"var(--c-primary)",width:2}),S(),new B({props:{decorations(e){const t=[];return e.doc.descendants((e,o)=>{if(e.type===fe.list_item&&null!==e.attrs.checked){const i=document.createElement("input");i.type="checkbox",i.checked=e.attrs.checked,i.className="task-checkbox",i.addEventListener("mousedown",t=>{t.preventDefault();const i=t.target.closest(".ProseMirror");if(!i)return;const s=i.pmView;if(!s)return;const n=s.state.tr.setNodeMarkup(o,void 0,{checked:!e.attrs.checked});s.dispatch(n)}),t.push(I.widget(o+1,i,{side:-1}))}}),D.create(e.doc,t)}}}),...t||[]]})}const ye=new W("slashMenu"),_e={active:!1,query:"",triggerPos:0,position:{top:0,left:0}};function Se(e){e.dispatch(e.state.tr.setMeta(ye,{close:!0}))}const $e=new W("dropUpload");function xe(e,t){const o=$e.getState(e.state);o?.isDragging!==t&&e.dispatch(e.state.tr.setMeta($e,{isDragging:t}))}function Le(e){return"image/png"===e||"image/jpeg"===e||"image/gif"===e||"image/webp"===e||"image/svg+xml"===e||"image/avif"===e||"application/pdf"===e}const Me=new Set(["image/png","image/jpeg","image/gif","image/webp","image/svg+xml","image/avif","application/pdf"]);function Ce(e){return e.startsWith("image/")}function Te(e,t,o,i){const s=e.state.tr.delete(t,o);e.dispatch(s),i(e)}function Be(e,t,o){const{state:i}=e,{$from:s}=i.selection;for(let u=s.depth;u>0;u--){const t=s.node(u);if(t.type===fe.bullet_list||t.type===fe.ordered_list)return void X(i,e.dispatch)}const n=s.before(s.depth),r=fe.paragraph.create(),a=fe.list_item.create(o||null,r),l=t.create(null,a),c=e.state.tr.replaceWith(n,s.after(s.depth),l),d=n+3;c.setSelection(G.near(c.doc.resolve(d))),e.dispatch(c)}const Ie=[{id:"paragraph",labelKey:"paragraph",keywords:["paragraph","text","plain"],icon:"T",execute:(e,t,o)=>{Te(e,t,o,e=>{V(fe.paragraph)(e.state,e.dispatch)})}},{id:"heading1",labelKey:"heading1",keywords:["heading","h1","title","header"],icon:"H1",execute:(e,t,o)=>{Te(e,t,o,e=>{V(fe.heading,{level:1})(e.state,e.dispatch)})}},{id:"heading2",labelKey:"heading2",keywords:["heading","h2","subtitle","header"],icon:"H2",execute:(e,t,o)=>{Te(e,t,o,e=>{V(fe.heading,{level:2})(e.state,e.dispatch)})}},{id:"heading3",labelKey:"heading3",keywords:["heading","h3","header"],icon:"H3",execute:(e,t,o)=>{Te(e,t,o,e=>{V(fe.heading,{level:3})(e.state,e.dispatch)})}},{id:"bulletList",labelKey:"bulletList",keywords:["bullet","list","unordered","ul"],icon:"‚Ä¢",execute:(e,t,o)=>{Te(e,t,o,e=>{Be(e,fe.bullet_list)})}},{id:"orderedList",labelKey:"orderedList",keywords:["ordered","list","numbered","ol"],icon:"1.",execute:(e,t,o)=>{Te(e,t,o,e=>{Be(e,fe.ordered_list)})}},{id:"taskList",labelKey:"taskList",keywords:["task","checkbox","todo","checklist","check"],icon:"‚òê",execute:(e,t,o)=>{Te(e,t,o,e=>{Be(e,fe.bullet_list,{checked:!1})})}},{id:"blockquote",labelKey:"blockquote",keywords:["quote","blockquote","citation"],icon:'"',execute:(e,t,o)=>{Te(e,t,o,e=>{R(fe.blockquote)(e.state,e.dispatch)})}},{id:"codeBlock",labelKey:"codeBlock",keywords:["code","codeblock","pre","programming"],icon:"</>",execute:(e,t,o)=>{Te(e,t,o,e=>{V(fe.code_block)(e.state,e.dispatch)})}},{id:"divider",labelKey:"divider",keywords:["divider","hr","horizontal","rule","line"],icon:"‚Äî",execute:(e,t,o)=>{const i=de.nodes.horizontal_rule;if(!i)return;let s=e.state.tr.delete(t,o);e.dispatch(s);const n=e.state.selection.$from.after(e.state.selection.$from.depth),r=i.create(),a=fe.paragraph.create();s=e.state.tr.insert(n,[r,a]),s.setSelection(G.near(s.doc.resolve(n+2))),e.dispatch(s)}},{id:"subpage",labelKey:"subpage",keywords:["subpage","page","child","nested","link"],icon:"üìÑ",asyncAction:"createSubpage",execute:()=>{}}];function De(e,t){const o=t.toLowerCase();return o===e?100:o.startsWith(e)?90:o.includes(e)?70:function(e,t){let o=0;for(let i=0;i<t.length&&o<e.length;i++)t[i]===e[o]&&o++;return o===e.length}(e,o)?50:0}function qe(e,t){if(!e)return Ie;const o=e.toLowerCase(),i=Ie.map(e=>{let i=0;i=Math.max(i,De(o,e.labelKey));for(const t of e.keywords)i=Math.max(i,De(o,t));if(t){const s=t(`slashMenu.${e.labelKey}`);s&&(i=Math.max(i,De(o,s)))}return{cmd:e,score:i}}).filter(e=>e.score>0);return i.sort((e,t)=>t.score-e.score),i.map(e=>e.cmd)}const Ee="_editorContainer_244bo_3",Ae="_floatingToolbar_244bo_12",ze="_formattingButtons_244bo_31",Pe="_formatButton_244bo_37",Ne="_isActive_244bo_58",Oe="_separator_244bo_63",Ke="_modeIndicator_244bo_71",Ue="_modeIndicatorActive_244bo_105",He="_prosemirrorEditor_244bo_112",Fe="_markdownEditor_244bo_354",je="_hidden_244bo_374",We="_slashMenu_244bo_379",Ge="_slashMenuItem_244bo_393",Ve="_selected_244bo_403",Re="_slashMenuIcon_244bo_407",Xe="_slashMenuLabel_244bo_421",Qe="_slashMenuEmpty_244bo_426";var Ye=f("<div data-testid=slash-command-menu>"),Je=f("<div>"),Ze=f("<div><span></span><span>");function et(f){const{t:h}=ee(),{user:g,wsApi:m}=te(),{loadNode:k,fetchNodeChildren:v}=oe(),{flushAutoSave:b}=ie(),[w,y]=e(0),[_,S]=e(null);let $;const x=()=>qe(f.state.query,h);t(()=>{f.state.query,f.state.active,y(0),S(null)}),t(()=>{f.state.active&&$&&requestAnimationFrame(()=>{if(!$)return;const e=$.getBoundingClientRect(),t=window.innerHeight,o=window.innerWidth;let i=f.state.position.top,s=f.state.position.left;if(0===i&&0===s)try{const e=f.view.coordsAtPos(f.state.triggerPos);i=e.bottom+4,s=e.left}catch{}if(i+e.height>t){i=f.view.coordsAtPos(f.state.triggerPos).top-e.height-4,i<0&&(i=8)}s+e.width>o&&(s=o-e.width-8),s<0&&(s=8),i===f.state.position.top&&s===f.state.position.left||S({top:i,left:s})})}),t(()=>{const e=w();if($){const t=$.querySelector(`[data-index="${e}"]`);t&&t.scrollIntoView({block:"nearest"})}}),se(()=>$,()=>{f.state.active&&Se(f.view)}),o(()=>{const e=e=>{const t=ye.getState(f.view.state);if(!t?.active)return;const o=qe(t.query,h);if(0!==o.length)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),y(e=>(e+1)%o.length);break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),y(e=>(e-1+o.length)%o.length);break;case"Enter":case"Tab":e.preventDefault(),e.stopPropagation(),L(o[w()]);break;case"Escape":e.preventDefault(),e.stopPropagation(),Se(f.view)}};document.addEventListener("keydown",e,!0),i(()=>{document.removeEventListener("keydown",e,!0)})});const L=async e=>{if(!e)return;const t=ye.getState(f.view.state);if(!t)return;const{triggerPos:o}=t,i=f.view.state.selection.from;if("createSubpage"===e.asyncAction){const e=m(),t=g(),n=f.nodeId;if(!e||!t||!n)return;const r=f.view.state.tr.delete(o,i);f.view.dispatch(r);try{const o=h("slashMenu.untitledSubpage")||"Untitled",i=await e.nodes.page.createPage(n,{title:o});if(!i?.id)return;const s=t.workspace_id,r=t.workspace_name,a=ne(s||"",r,i.id,o),l=he.link.create({href:a,title:null}),c=de.text(o,[l]),d=f.view.state.tr.insert(f.view.state.selection.from,c);f.view.dispatch(d),b(),await v(n),await k(i.id)}catch(s){console.error("Failed to create subpage:",s)}return void f.view.focus()}e.execute(f.view,o,i),f.view.focus()},M=()=>_()??f.state.position;return s(n,{get when(){return f.state.active},get children(){var e=Ye();return"function"==typeof $?r($,e):$=e,a(e,s(n,{get when(){return x().length>0},get fallback(){return e=Je(),a(e,()=>h("slashMenu.noResults")),c(()=>d(e,Qe)),e;var e},get children(){return s(l,{get each(){return x()},children:(e,t)=>{return o=Ze(),i=o.firstChild,s=i.nextSibling,o.addEventListener("mouseenter",()=>(e=>{y(e)})(t())),o.$$click=()=>(e=>{L(e)})(e),a(i,()=>e.icon),a(s,()=>h(`slashMenu.${e.labelKey}`)),c(e=>{var n=`${Ge} ${t()===w()?Ve:""}`,r=t(),a=Re,l=Xe;return n!==e.e&&d(o,e.e=n),r!==e.t&&u(o,"data-index",e.t=r),a!==e.a&&d(i,e.a=a),l!==e.o&&d(s,e.o=l),e},{e:void 0,t:void 0,a:void 0,o:void 0}),o;var o,i,s}})}})),c(t=>{var o=We,i=`${M().top}px`,s=`${M().left}px`,n=(()=>{const e=M();return 0!==e.top||0!==e.left})()?"visible":"hidden";return o!==t.e&&d(e,t.e=o),i!==t.t&&p(e,"top",t.t=i),s!==t.a&&p(e,"left",t.a=s),n!==t.o&&p(e,"visibility",t.o=n),t},{e:void 0,t:void 0,a:void 0,o:void 0}),e}})}h(["click"]);var tt=f('<div data-testid=floating-toolbar><div><button title="Bold (Ctrl+B)">B</button><button title="Italic (Ctrl+I)">I</button><button title="Underline (Ctrl+U)"><u>U</u></button><button title="Code (Ctrl+`)">&lt;/></button><span></span><button title="Heading 1">H1</button><button title="Heading 2">H2</button><button title="Heading 3">H3</button><span></span><button title="Bullet List">‚Ä¢</button><button title="Numbered List">1.</button><button title="Task List">‚òê</button><button title=Quote>"</button><button title="Code Block">&lt;/>');function ot(e){const t=e=>e?`${Pe} ${Ne}`:Pe,o=()=>{if(!e.view)return{isBulletList:!1,isOrderedList:!1,isTaskList:!1};const{state:t}=e.view,{from:o,to:i,$from:s}=t.selection;let n=!1,r=!1,a=!1;for(let e=s.depth;e>0;e--){const t=s.node(e);t.type===fe.bullet_list&&(n=!0),t.type===fe.ordered_list&&(r=!0),t.type===fe.list_item&&null!==t.attrs.checked&&(a=!0)}return n||r||a||t.doc.nodesBetween(o,i,e=>{e.type===fe.bullet_list&&(n=!0),e.type===fe.ordered_list&&(r=!0),e.type===fe.list_item&&null!==e.attrs.checked&&(a=!0)}),a&&(n=!1),{isBulletList:n,isOrderedList:r,isTaskList:a}},i=()=>{e.view&&(K(he.strong)(e.view.state,e.view.dispatch),e.view.focus())},r=()=>{e.view&&(K(he.em)(e.view.state,e.view.dispatch),e.view.focus())},a=()=>{e.view&&(K(he.underline)(e.view.state,e.view.dispatch),e.view.focus())},l=()=>{e.view&&(K(he.code)(e.view.state,e.view.dispatch),e.view.focus())},u=t=>{if(!e.view)return;const{state:o,dispatch:i}=e.view;e.formatState.headingLevel===t?V(fe.paragraph)(o,i):V(fe.heading,{level:t})(o,i),e.view.focus()},f=()=>{if(!e.view)return;const{state:t,dispatch:o}=e.view,{from:i,to:s,$from:n}=t.selection;let r=null,a=0;for(let e=n.depth;e>0;e--){const t=n.node(e);if(t.type===fe.bullet_list||t.type===fe.ordered_list){r=t,a=n.before(e);break}}if(r||t.doc.nodesBetween(i,s,(e,t)=>{r||e.type!==fe.bullet_list&&e.type!==fe.ordered_list||(r=e,a=t)}),r){const e=a+r.nodeSize,n=t.selection instanceof Q||i<=1&&s>=t.doc.content.size-1,l=i>=a&&s<=e,c=[];r.forEach(e=>{e.forEach(e=>{c.push(e)})});let d=0;for(const t of c)d+=t.nodeSize;const u=t.tr.replaceWith(a,e,c);if(n)u.setSelection(new Q(u.doc));else if(i!==s&&l)try{const e=a+1,t=a+d-1;u.setSelection(Y.create(u.doc,e,t))}catch{u.setSelection(G.near(u.doc.resolve(a)))}else if(i!==s)try{const e=u.mapping.map(i),t=u.mapping.map(s);u.setSelection(Y.create(u.doc,e,t))}catch{u.setSelection(G.near(u.doc.resolve(a)))}o(u)}},h=t=>{if(!e.view)return;const{state:o,dispatch:i}=e.view,{from:s,to:n,$from:r}=o.selection;let a=null,l=0;for(let e=r.depth;e>0;e--){const t=r.node(e);if(t.type===fe.bullet_list||t.type===fe.ordered_list){a=t,l=r.before(e);break}}if(a||o.doc.nodesBetween(s,n,(e,t)=>{a||e.type!==fe.bullet_list&&e.type!==fe.ordered_list||(a=e,l=t)}),a){const e=o.selection instanceof Q||s<=1&&n>=o.doc.content.size-1,r=o.tr.setNodeMarkup(l,t);if(t===fe.ordered_list&&r.doc.nodesBetween(l,l+a.nodeSize,(e,t)=>{e.type===fe.list_item&&null!==e.attrs.checked&&r.setNodeMarkup(t,void 0,{checked:null})}),e)r.setSelection(new Q(r.doc));else if(s!==n)try{const e=r.mapping.map(s),t=r.mapping.map(n);r.setSelection(Y.create(r.doc,e,t))}catch{}i(r)}},g=t=>{if(!e.view)return;const{state:o,dispatch:i}=e.view,{from:s,to:n}=o.selection,r=o.selection instanceof Q||s<=1&&n>=o.doc.content.size-1;J(t)(o,e=>{if(r)e.setSelection(new Q(e.doc));else if(s!==n)try{const t=e.mapping.map(s),o=e.mapping.map(n);e.setSelection(Y.create(e.doc,t,o))}catch{}i(e)})},m=()=>{if(!e.view)return;const{state:t,dispatch:i}=e.view,{from:s,to:n}=t.selection,r=o();if(r.isBulletList)f();else if(r.isOrderedList)h(fe.bullet_list);else if(r.isTaskList){const{$from:e}=t.selection,o=t.selection instanceof Q||s<=1&&n>=t.doc.content.size-1;for(let r=e.depth;r>0;r--){const a=e.node(r);if(a.type===fe.bullet_list){const l=e.before(r);let c=t.tr;if(t.doc.nodesBetween(l,l+a.nodeSize,(e,t)=>{e.type===fe.list_item&&null!==e.attrs.checked&&(c=c.setNodeMarkup(t,void 0,{checked:null}))}),c.docChanged){if(o)c.setSelection(new Q(c.doc));else if(s!==n)try{const e=c.mapping.map(s),t=c.mapping.map(n);c.setSelection(Y.create(c.doc,e,t))}catch{}i(c)}break}}}else g(fe.bullet_list);e.view.focus()},k=()=>{if(!e.view)return;const t=o();t.isOrderedList?f():t.isBulletList||t.isTaskList?h(fe.ordered_list):g(fe.ordered_list),e.view.focus()},v=()=>{if(!e.view)return;const{state:t,dispatch:i}=e.view,{from:s,to:n,$from:r}=t.selection,a=e=>{for(let t=r.depth;t>0;t--){const o=r.node(t);if(o.type===e)return{start:r.before(t),node:o}}let o=null;return t.doc.nodesBetween(s,n,(t,i)=>{o||t.type!==e||(o={start:i,node:t})}),o},l=t.selection instanceof Q||s<=1&&n>=t.doc.content.size-1,c=e=>{if(l)e.setSelection(new Q(e.doc));else if(s!==n)try{const t=e.mapping.map(s),o=e.mapping.map(n);e.setSelection(Y.create(e.doc,t,o))}catch{}},d=o();if(d.isTaskList)f();else if(d.isBulletList){const e=a(fe.bullet_list);if(e){let o=t.tr;t.doc.nodesBetween(e.start,e.start+e.node.nodeSize,(e,t)=>{e.type===fe.list_item&&null===e.attrs.checked&&(o=o.setNodeMarkup(t,void 0,{checked:!1}))}),o.docChanged&&(c(o),i(o))}}else if(d.isOrderedList){const e=a(fe.ordered_list);if(e){let o=t.tr.setNodeMarkup(e.start,fe.bullet_list);o.doc.nodesBetween(e.start,e.start+e.node.nodeSize,(e,t)=>{e.type===fe.list_item&&(o=o.setNodeMarkup(t,void 0,{checked:!1}))}),c(o),i(o)}}else J(fe.bullet_list)(t,e=>{let t=e;e.doc.descendants((e,o)=>{e.type===fe.list_item&&null===e.attrs.checked&&(t=t.setNodeMarkup(o,void 0,{checked:!1}))}),c(t),i(t)});e.view.focus()},b=()=>{if(!e.view)return;const{state:t,dispatch:o}=e.view;e.formatState.isBlockquote?X(t,o):R(fe.blockquote)(t,o),e.view.focus()},w=()=>{if(!e.view)return;const{state:t,dispatch:o}=e.view;e.formatState.isCodeBlock?V(fe.paragraph)(t,o):V(fe.code_block)(t,o),e.view.focus()};return s(n,{get when(){return e.position},get children(){var o=tt(),s=o.firstChild,n=s.firstChild,f=n.nextSibling,h=f.nextSibling,g=h.nextSibling,y=g.nextSibling,_=y.nextSibling,S=_.nextSibling,$=S.nextSibling,x=$.nextSibling,L=x.nextSibling,M=L.nextSibling,C=M.nextSibling,T=C.nextSibling,B=T.nextSibling;return n.$$click=i,f.$$click=r,h.$$click=a,g.$$click=l,_.$$click=()=>u(1),S.$$click=()=>u(2),$.$$click=()=>u(3),L.$$click=m,M.$$click=k,C.$$click=v,T.$$click=b,B.$$click=w,c(i=>{var r=Ae,a=`${e.position?.top??0}px`,l=`${e.position?.left??0}px`,c=ze,u=t(e.formatState.isBold),m=t(e.formatState.isItalic),k=t(e.formatState.isUnderline),v=t(e.formatState.isCode),b=Oe,w=t(1===e.formatState.headingLevel),I=t(2===e.formatState.headingLevel),D=t(3===e.formatState.headingLevel),q=Oe,E=t(e.formatState.isBulletList),A=t(e.formatState.isOrderedList),z=t(e.formatState.isTaskList),P=t(e.formatState.isBlockquote),N=t(e.formatState.isCodeBlock);return r!==i.e&&d(o,i.e=r),a!==i.t&&p(o,"top",i.t=a),l!==i.a&&p(o,"left",i.a=l),c!==i.o&&d(s,i.o=c),u!==i.i&&d(n,i.i=u),m!==i.n&&d(f,i.n=m),k!==i.s&&d(h,i.s=k),v!==i.h&&d(g,i.h=v),b!==i.r&&d(y,i.r=b),w!==i.d&&d(_,i.d=w),I!==i.l&&d(S,i.l=I),D!==i.u&&d($,i.u=D),q!==i.c&&d(x,i.c=q),E!==i.w&&d(L,i.w=E),A!==i.m&&d(M,i.m=A),z!==i.f&&d(C,i.f=z),P!==i.y&&d(T,i.y=P),N!==i.g&&d(B,i.g=N),i},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0,w:void 0,m:void 0,f:void 0,y:void 0,g:void 0}),o}})}h(["click"]);var it=f('<div><div data-testid=wysiwyg-editor></div><textarea data-testid=markdown-editor></textarea><div><button title="Visual mode (Ctrl+Shift+M)"data-testid=editor-mode-visual>Visual</button><button title="Markdown mode (Ctrl+Shift+M)"data-testid=editor-mode-markdown>MD');function st(n){const{t:l}=ee(),[p,f]=e("wysiwyg"),[h,k]=e(n.content),[v,b]=e(),[w,y]=e({active:!1,query:"",triggerPos:0,position:{top:0,left:0}});let _;const S=($=y,new B({key:ye,state:{init:()=>({..._e}),apply(e,t,o,i){const s=e.getMeta(ye);if(s?.close){if(t.active){const e={..._e};return setTimeout(()=>$(e),0),e}return t}if(!e.docChanged&&!e.selectionSet)return t;const{selection:n}=i,{$from:r}=n;if(!n.empty){if(t.active){const e={..._e};return setTimeout(()=>$(e),0),e}return t}const a=r.start(r.depth),l=i.doc.textBetween(a,r.pos,"",""),c=l.match(/(^|\s)\/([^\s]*)$/);if(c){const e=c[2]||"",o={active:!0,query:e,triggerPos:a+(l.length-c[0].length+(c[1]?1:0)),position:t.position};return t.active&&e!==t.query&&setTimeout(()=>$(o),0),o}if(t.active){const e={..._e};return setTimeout(()=>$(e),0),e}return t}},view:e=>({update(e){const t=ye.getState(e.state);if(t?.active)try{const o=e.coordsAtPos(t.triggerPos),i=o.bottom+4,s=o.left,n=i>0||s>0?{top:i,left:s}:t.position,r={...t,position:n};$(r)}catch{$(t)}}}),props:{handleKeyDown(e,t){const o=ye.getState(e.state);return!!o?.active&&("ArrowDown"===t.key||"ArrowUp"===t.key||"Enter"===t.key||"Tab"===t.key||"Escape"===t.key&&(Se(e),!0))}}}));var $;const x=(L={onFileDrop:async(t,o)=>{const i=v();if(!(i&&n.wsId&&n.nodeId&&n.getToken))return;const{uploadFile:s,error:r}=function(t){const[o,i]=e(!1),[s,n]=e(null);return{uploadFile:async e=>{if(n(null),e.size>10485760){const t=`File too large: ${e.name} (max 10MB)`;return n(t),console.error(t),null}if(!Me.has(e.type)){const t=`Unsupported file type: ${e.type}`;return n(t),console.error(t),null}const o=t.getToken();if(!o){const e="Not authenticated";return n(e),console.error(e),null}i(!0);try{const i=new FormData;i.append("file",e);const s=await fetch(`/api/workspaces/${t.wsId}/nodes/${t.nodeId}/assets`,{method:"POST",headers:{Authorization:`Bearer ${o}`},body:i});if(!s.ok){const e=await s.text();throw new Error(`Upload failed: ${s.status} ${e}`)}const n=await s.json();return{name:n.name,mimeType:n.mime_type,url:n.url}}catch(s){const e=s instanceof Error?s.message:String(s);return n(e),console.error("Asset upload failed:",s),null}finally{i(!1)}},uploading:o,error:s}}({wsId:n.wsId,nodeId:n.nodeId,getToken:n.getToken});for(const e of t){const t=await s(e);if(t){const e=Ce(t.mimeType);let s=i.state.tr;if(e){const e=de.nodes.image;if(e){const i=e.create({src:t.url,alt:t.name,title:null});s=s.insert(o,i)}}else{const e=de.marks.link;if(e){const i=e.create({href:t.url,title:null}),n=de.text(t.name,[i]);s=s.insert(o,n)}}i.dispatch(s),n.onAssetUploaded?.()}else{const e=r();e&&n.onError?.(e)}}}},new B({key:$e,state:{init:()=>({isDragging:!1}),apply(e,t){const o=e.getMeta($e);return void 0!==o?{isDragging:o.isDragging}:t}},props:{attributes(e){const t=$e.getState(e);return t?.isDragging?{class:"drop-target-active"}:{}},handleDOMEvents:{dragenter:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),xe(e,!0),!1),dragover:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),!1),dragleave(e,t){const o=t.relatedTarget,i=e.dom;return o&&i.contains(o)||xe(e,!1),!1},drop(e,t){xe(e,!1);const o=t.dataTransfer?.files;if(!o||0===o.length)return!1;const i=[];for(const n of o)Le(n.type)&&i.push(n);if(0===i.length)return!1;t.preventDefault();const s=e.posAtCoords({left:t.clientX,top:t.clientY});return s?(L.onFileDrop(i,s.pos),!0):(L.onFileDrop(i,e.state.doc.content.size),!0)}}}}));var L;let M=n.nodeId,C=n.content,T=n.linkedNodeTitles;const[I,D]=e({isBold:!1,isItalic:!1,isUnderline:!1,isCode:!1,headingLevel:null,isBulletList:!1,isOrderedList:!1,isTaskList:!1,isBlockquote:!1,isCodeBlock:!1}),[q,E]=e(null),A=e=>{let t=re(e,n.assetUrls||{});return n.wsId&&n.linkedNodeTitles&&Object.keys(n.linkedNodeTitles).length>0&&(t=ae(t,n.linkedNodeTitles,n.wsId)),me.parse(t)},z=e=>{const t=ke.serialize(e);return le(t,n.assetUrls||{})},P=e=>{const{state:t}=e,{from:o,$from:i,to:s,empty:n}=t.selection;if(n||"markdown"===p())E(null);else try{const t=e.coordsAtPos(o),i=e.coordsAtPos(s),n=Math.abs(t.top-i.top)<20;let r=t.left;r=n?(t.left+i.right)/2:t.left+40,E({top:t.top,left:r})}catch{E(null)}const r=n?t.storedMarks||i.marks():[],a=void 0!==he.strong.isInSet(r)||t.doc.rangeHasMark(o,s,he.strong),l=void 0!==he.em.isInSet(r)||t.doc.rangeHasMark(o,s,he.em),c=void 0!==he.underline.isInSet(r)||t.doc.rangeHasMark(o,s,he.underline),d=void 0!==he.code.isInSet(r)||t.doc.rangeHasMark(o,s,he.code),u=i.node(i.depth),f=u.type===fe.heading?u.attrs.level:null,h=u.type===fe.code_block;let g=!1,m=!1,k=!1,v=!1;for(let p=i.depth;p>0;p--){const e=i.node(p);e.type===fe.bullet_list&&(g=!0),e.type===fe.ordered_list&&(m=!0),e.type===fe.list_item&&null!==e.attrs.checked&&(k=!0),e.type===fe.blockquote&&(v=!0)}g||m||k||t.doc.nodesBetween(o,s,e=>{e.type===fe.bullet_list&&(g=!0),e.type===fe.ordered_list&&(m=!0),e.type===fe.list_item&&null!==e.attrs.checked&&(k=!0),e.type===fe.blockquote&&(v=!0)}),k&&(g=!1),D({isBold:a,isItalic:l,isUnderline:c,isCode:d,headingLevel:f,isBulletList:g,isOrderedList:m,isTaskList:k,isBlockquote:v,isCodeBlock:h})};o(()=>{if(!_)return;const e=A(n.content);if(!e)return;const t=we(e,[S,x]),o=new Z(_,{state:t,editable:()=>!n.readOnly,dispatchTransaction(e){const t=o.state.apply(e);if(o.updateState(t),e.docChanged){const e=z(t.doc);k(e),C=e,n.onChange(e)}P(o)}}),i=_.querySelector(".ProseMirror");i&&(i.pmView=o),b(o),P(o)}),i(()=>{v()?.destroy()}),t(g(()=>[n.nodeId,n.content,n.linkedNodeTitles],([e,t,o])=>{const i=e!==M,s=t!==C;if(i||s||o!==T){M=e,C=t,T=o,(i||s)&&(k(t),f("wysiwyg"));const n=v();if(n){const e=A(t);if(e){const t=we(e,[S,x]);n.updateState(t)}}}},{defer:!0}));const N=()=>{const e=v();if(e){const t=A(h());if(t){const o=we(t,[S,x]);e.updateState(o),P(e)}}f("wysiwyg")},O=()=>{const e=v();if(e){const t=z(e.state.doc);k(t)}f("markdown")},K=e=>{e.ctrlKey&&e.shiftKey&&"m"===e.key.toLowerCase()&&(e.preventDefault(),"wysiwyg"===p()?O():N())};o(()=>{document.addEventListener("keydown",K)}),i(()=>{document.removeEventListener("keydown",K)});const U=m(()=>"wysiwyg"===p()?He:`${He} ${je}`),H=m(()=>"markdown"===p()?Fe:`${Fe} ${je}`);return(()=>{var e=it(),t=e.firstChild,o=t.nextSibling,i=o.nextSibling,f=i.firstChild,g=f.nextSibling;a(e,s(ot,{get formatState(){return I()},get view(){return v()},get position(){return q()}}),t);return"function"==typeof _?r(_,t):_=t,o.$$input=e=>{return t=e.target.value,k(t),C=t,void n.onChange(t);var t},f.$$click=N,g.$$click=O,a(e,()=>{const e=v();return e?s(et,{view:e,get state(){return w()},get nodeId(){return n.nodeId}}):null},null),c(s=>{var r=Ee,a=U(),c=H(),h=n.placeholder||l("editor.contentPlaceholder")||"Write markdown...",m=n.readOnly,k=Ke,v="wysiwyg"===p()?Ue:void 0,b="markdown"===p()?Ue:void 0;return r!==s.e&&d(e,s.e=r),a!==s.t&&d(t,s.t=a),c!==s.a&&d(o,s.a=c),h!==s.o&&u(o,"placeholder",s.o=h),m!==s.i&&(o.readOnly=s.i=m),k!==s.n&&d(i,s.n=k),v!==s.s&&d(f,s.s=v),b!==s.h&&d(g,s.h=b),s},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),c(()=>o.value=h()),e})()}h(["input","click"]);export{st as default};
