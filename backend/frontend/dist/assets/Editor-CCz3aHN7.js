import{c as e,C as t,h as o,o as i,m as n,d as s,S as r,K as a,q as l,F as c,s as d,v as u,z as p,A as h,w as f,n as g,I as k,y as m,g as v}from"./vendor-DpNS6KG6.js";import{S as w,a as b,b as y,E as _,k as S,h as $,d as x,g as M,s as L,M as T,c as C,w as B,t as z,i as I,P as E,D,e as N,f as A,j as q,l as P,I as O,u as K,r as H,m as U,n as F,o as W,p as j,q as G,v as R,x as V,y as X,z as Q,A as Y,B as Z,T as J,C as ee,F as te}from"./editor-vendor-CwXjZW82.js";import{u as oe,d as ie,g as ne,h as se,i as re,n as ae,r as le,j as ce,k as de}from"./index-4a7egvSb.js";const ue=L.spec.nodes.get("list_item");if(!ue)throw new Error("list_item node not found in schema");const pe=new w({nodes:L.spec.nodes.update("list_item",{...ue,attrs:{checked:{default:null}},toDOM:e=>null!==e.attrs.checked?["li",{class:"task-list-item","data-checked":String(e.attrs.checked)},0]:["li",0],parseDOM:[{tag:"li",getAttrs:e=>e.classList.contains("task-list-item")?{checked:"true"===e.dataset.checked}:{checked:null}}]}),marks:L.spec.marks.addToEnd("underline",{parseDOM:[{tag:"u"},{style:"text-decoration=underline"}],toDOM:()=>["u",0]}).addToEnd("strikethrough",{parseDOM:[{tag:"s"},{tag:"del"},{style:"text-decoration=line-through"}],toDOM:()=>["s",0]})});function he(e){const t=pe.nodes[e];if(!t)throw new Error(`Node type '${e}' not found in schema`);return t}function fe(e){const t=pe.marks[e];if(!t)throw new Error(`Mark type '${e}' not found in schema`);return t}const ge={doc:he("doc"),list_item:he("list_item"),bullet_list:he("bullet_list"),ordered_list:he("ordered_list"),paragraph:he("paragraph"),blockquote:he("blockquote"),code_block:he("code_block"),heading:he("heading")},ke={strong:fe("strong"),em:fe("em"),code:fe("code"),link:fe("link"),underline:fe("underline"),strikethrough:fe("strikethrough")},me=new T;me.inline.ruler.before("html_inline","underline",(e,t)=>{const o=e.pos,i=e.posMax,n=e.src;if("<u>"!==n.slice(o,o+3).toLowerCase())return!1;const s="</u>",r=n.toLowerCase().indexOf(s,o+3);if(-1===r||r>=i)return!1;if(!t){e.push("underline_open","u",1).markup="<u>";const t=n.slice(o+3,r);e.push("text","",0).content=t;e.push("underline_close","u",-1).markup="</u>"}return e.pos=r+4,!0}),me.core.ruler.after("inline","task_list",e=>{const t=e.tokens;for(let o=0;o<t.length;o++){const e=t[o];if(e&&"list_item_open"===e.type){const i=t[o+2];if(i&&"inline"===i.type&&i.children){const t=i.children[0];if(t&&"text"===t.type&&t.content){const o=t.content.match(/^\[([ xX])\]\s*/);o&&o[1]&&(e.attrSet("checked","x"===o[1].toLowerCase()?"true":"false"),t.content=t.content.slice(o[0].length))}}}}return!0});const ve=new b(pe,me,{blockquote:{block:"blockquote"},paragraph:{block:"paragraph"},list_item:{block:"list_item",getAttrs:e=>{const t=e.attrGet("checked");return"true"===t?{checked:!0}:"false"===t?{checked:!1}:{checked:null}}},bullet_list:{block:"bullet_list"},ordered_list:{block:"ordered_list",getAttrs:e=>({order:+(e.attrGet("start")||1)})},heading:{block:"heading",getAttrs:e=>({level:+e.tag.slice(1)})},code_block:{block:"code_block",noCloseToken:!0},fence:{block:"code_block",getAttrs:e=>({params:e.info||""}),noCloseToken:!0},hr:{node:"horizontal_rule"},image:{node:"image",getAttrs:e=>({src:e.attrGet("src"),title:e.attrGet("title")||null,alt:e.children?.[0]?.content||null})},hardbreak:{node:"hard_break"},em:{mark:"em"},strong:{mark:"strong"},underline:{mark:"underline"},s:{mark:"strikethrough"},link:{mark:"link",getAttrs:e=>({href:e.attrGet("href"),title:e.attrGet("title")||null})},code_inline:{mark:"code"},table:{block:"paragraph",noCloseToken:!1},thead:{ignore:!0},tbody:{ignore:!0},tr:{ignore:!0},th:{block:"paragraph"},td:{block:"paragraph"}}),we=new y({...C.nodes,bullet_list(e,t){e.renderList(t,"  ",()=>"- ")},list_item(e,t){if(null!==t.attrs.checked){const o=t.attrs.checked?"[x] ":"[ ] ";e.write(o)}e.renderContent(t)}},{...C.marks,underline:{open:"<u>",close:"</u>",mixable:!0,expelEnclosingWhitespace:!0},strikethrough:{open:"~~",close:"~~",mixable:!0,expelEnclosingWhitespace:!0}});function be(){const e=A.concat(q,P);e.push(new O(/^\s*-\s+\[([ xX])\]\s$/,(e,t,o,i)=>{const n=e.doc.resolve(o),s="x"===t[1]?.toLowerCase();for(let l=n.depth;l>0;l--)if(n.node(l).type===ge.list_item){const t=e.tr.delete(o,i);return t.setNodeMarkup(n.before(l),void 0,{checked:s}),t}const r=ge.list_item.create({checked:s},ge.paragraph.create()),a=ge.bullet_list.create(null,r);return e.tr.replaceWith(o,i,a)})),e.push(B(/^\s*>\s$/,ge.blockquote)),e.push(B(/^\s*([-*])\s$/,ge.bullet_list)),e.push(B(/^(\d+)\.\s$/,ge.ordered_list,e=>({order:+(e[1]??1)}),(e,t)=>t.childCount+t.attrs.order===+(e[1]??1))),e.push(z(/^```$/,ge.code_block));for(let t=1;t<=6;t++){const o=new RegExp(`^(#{${t}})\\s$`);e.push(z(o,ge.heading,{level:t}))}return I({rules:e})}function ye(){const e={};return e["Mod-z"]=K,e["Mod-y"]=H,e["Mod-Shift-z"]=H,e["Mod-b"]=U(ke.strong),e["Mod-i"]=U(ke.em),e["Mod-u"]=U(ke.underline),e["Mod-Shift-x"]=U(ke.strikethrough),e["Mod-`"]=U(ke.code),e.Enter=(e,t)=>{const{$from:o}=e.selection;for(let i=o.depth;i>0;i--){const n=o.node(i);if(n.type===ge.list_item&&null!==n.attrs.checked){if(t){return F(ge.list_item)(e,e=>{const o=e.selection.$from;for(let t=o.depth;t>0;t--){if(o.node(t).type===ge.list_item){e.setNodeMarkup(o.before(t),void 0,{checked:!1});break}}t(e)})}return F(ge.list_item)(e)}}return F(ge.list_item)(e,t)},e.Tab=W(ge.list_item),e["Shift-Tab"]=j(ge.list_item),S(e)}function _e(e,t){return _.create({doc:e,plugins:[be(),ye(),S(G),$(),x({color:"var(--c-primary)",width:2}),M(),new E({props:{decorations(e){const t=[];return e.doc.descendants((e,o)=>{if(e.type===ge.list_item&&null!==e.attrs.checked){const i=document.createElement("input");i.type="checkbox",i.checked=e.attrs.checked,i.className="task-checkbox",i.addEventListener("mousedown",t=>{t.preventDefault();const i=t.target.closest(".ProseMirror");if(!i)return;const n=i.pmView;if(!n)return;const s=n.state.tr.setNodeMarkup(o,void 0,{checked:!e.attrs.checked});n.dispatch(s)}),t.push(D.widget(o+1,i,{side:-1}))}}),N.create(e.doc,t)}}}),...t||[]]})}const Se=new R("slashMenu"),$e={active:!1,query:"",triggerPos:0,position:{top:0,left:0}};function xe(e){e.dispatch(e.state.tr.setMeta(Se,{close:!0}))}const Me=new R("dropUpload");function Le(e,t){const o=Me.getState(e.state);o?.isDragging!==t&&e.dispatch(e.state.tr.setMeta(Me,{isDragging:t}))}function Te(e){return"image/png"===e||"image/jpeg"===e||"image/gif"===e||"image/webp"===e||"image/svg+xml"===e||"image/avif"===e||"application/pdf"===e}const Ce=/^\/w\/([^/+]+)(?:\+[^/]*)?\/([a-zA-Z0-9_-]+)(?:\+.*)?$/,Be=new R("invalidLink");function ze(e,t,o){const i=[];return e.descendants((e,n)=>{if(e.isText){const s=e.marks.find(e=>"link"===e.type.name);if(s&&s.attrs.href){(function(e,t,o){if(!o||!e)return!1;const i=e.match(Ce);if(!i)return e.startsWith("/w/")&&console.warn("[invalidLink] Pattern did not match:",e),!1;const n=i[1],s=i[2];return n===o&&!!s&&!(s in t)})(s.attrs.href,t,o)&&i.push(D.inline(n,n+e.nodeSize,{class:"invalid-link"}))}}return!0}),N.create(e,i)}function Ie(e,t,o){const i=e.state.tr.setMeta(Be,{linkedNodeTitles:t,wsId:o});e.dispatch(i)}const Ee=new Set(["image/png","image/jpeg","image/gif","image/webp","image/svg+xml","image/avif","application/pdf"]);function De(e){return e.startsWith("image/")}function Ne(e,t,o,i){const n=e.state.tr.delete(t,o);e.dispatch(n),i(e)}function Ae(e,t,o){const{state:i}=e,{$from:n}=i.selection;for(let u=n.depth;u>0;u--){const t=n.node(u);if(t.type===ge.bullet_list||t.type===ge.ordered_list)return void Y(i,e.dispatch)}const s=n.before(n.depth),r=ge.paragraph.create(),a=ge.list_item.create(o||null,r),l=t.create(null,a),c=e.state.tr.replaceWith(s,n.after(n.depth),l),d=s+3;c.setSelection(V.near(c.doc.resolve(d))),e.dispatch(c)}const qe=[{id:"paragraph",labelKey:"paragraph",keywords:["paragraph","text","plain"],icon:"T",execute:(e,t,o)=>{Ne(e,t,o,e=>{X(ge.paragraph)(e.state,e.dispatch)})}},{id:"heading1",labelKey:"heading1",keywords:["heading","h1","title","header"],icon:"H1",execute:(e,t,o)=>{Ne(e,t,o,e=>{X(ge.heading,{level:1})(e.state,e.dispatch)})}},{id:"heading2",labelKey:"heading2",keywords:["heading","h2","subtitle","header"],icon:"H2",execute:(e,t,o)=>{Ne(e,t,o,e=>{X(ge.heading,{level:2})(e.state,e.dispatch)})}},{id:"heading3",labelKey:"heading3",keywords:["heading","h3","header"],icon:"H3",execute:(e,t,o)=>{Ne(e,t,o,e=>{X(ge.heading,{level:3})(e.state,e.dispatch)})}},{id:"bulletList",labelKey:"bulletList",keywords:["bullet","list","unordered","ul"],icon:"‚Ä¢",execute:(e,t,o)=>{Ne(e,t,o,e=>{Ae(e,ge.bullet_list)})}},{id:"orderedList",labelKey:"orderedList",keywords:["ordered","list","numbered","ol"],icon:"1.",execute:(e,t,o)=>{Ne(e,t,o,e=>{Ae(e,ge.ordered_list)})}},{id:"taskList",labelKey:"taskList",keywords:["task","checkbox","todo","checklist","check"],icon:"‚òê",execute:(e,t,o)=>{Ne(e,t,o,e=>{Ae(e,ge.bullet_list,{checked:!1})})}},{id:"blockquote",labelKey:"blockquote",keywords:["quote","blockquote","citation"],icon:'"',execute:(e,t,o)=>{Ne(e,t,o,e=>{Q(ge.blockquote)(e.state,e.dispatch)})}},{id:"codeBlock",labelKey:"codeBlock",keywords:["code","codeblock","pre","programming"],icon:"</>",execute:(e,t,o)=>{Ne(e,t,o,e=>{X(ge.code_block)(e.state,e.dispatch)})}},{id:"divider",labelKey:"divider",keywords:["divider","hr","horizontal","rule","line"],icon:"‚Äî",execute:(e,t,o)=>{const i=pe.nodes.horizontal_rule;if(!i)return;let n=e.state.tr.delete(t,o);e.dispatch(n);const s=e.state.selection.$from.after(e.state.selection.$from.depth),r=i.create(),a=ge.paragraph.create();n=e.state.tr.insert(s,[r,a]),n.setSelection(V.near(n.doc.resolve(s+2))),e.dispatch(n)}},{id:"subpage",labelKey:"subpage",keywords:["subpage","page","child","nested","link"],icon:"üìÑ",asyncAction:"createSubpage",execute:()=>{}}];function Pe(e,t){const o=t.toLowerCase();return o===e?100:o.startsWith(e)?90:o.includes(e)?70:function(e,t){let o=0;for(let i=0;i<t.length&&o<e.length;i++)t[i]===e[o]&&o++;return o===e.length}(e,o)?50:0}function Oe(e,t){if(!e)return qe;const o=e.toLowerCase(),i=qe.map(e=>{let i=0;i=Math.max(i,Pe(o,e.labelKey));for(const t of e.keywords)i=Math.max(i,Pe(o,t));if(t){const n=t(`slashMenu.${e.labelKey}`);n&&(i=Math.max(i,Pe(o,n)))}return{cmd:e,score:i}}).filter(e=>e.score>0);return i.sort((e,t)=>t.score-e.score),i.map(e=>e.cmd)}const Ke="_editorContainer_ha4z0_3",He="_floatingToolbar_ha4z0_12",Ue="_above_ha4z0_31",Fe="_toolbarRow_ha4z0_37",We="_formatButton_ha4z0_44",je="_isActive_ha4z0_65",Ge="_separator_ha4z0_70",Re="_modeIndicator_ha4z0_78",Ve="_modeIndicatorActive_ha4z0_112",Xe="_prosemirrorEditor_ha4z0_119",Qe="_markdownEditor_ha4z0_373",Ye="_hidden_ha4z0_393",Ze="_slashMenu_ha4z0_398",Je="_slashMenuItem_ha4z0_412",et="_selected_ha4z0_422",tt="_slashMenuIcon_ha4z0_426",ot="_slashMenuLabel_ha4z0_440",it="_slashMenuEmpty_ha4z0_445";var nt=f("<div data-testid=slash-command-menu>"),st=f("<div>"),rt=f("<div><span></span><span>");function at(f){const{t:g}=oe(),k=t(),{user:m,wsApi:v}=ie(),{loadNode:w,fetchNodeChildren:b}=ne(),{flushAutoSave:y}=se(),[_,S]=e(0),[$,x]=e(null);let M;const L=()=>Oe(f.state.query,g);o(()=>{f.state.query,f.state.active,S(0),x(null)}),o(()=>{f.state.active&&M&&requestAnimationFrame(()=>{if(!M)return;const e=M.getBoundingClientRect(),t=window.innerHeight,o=window.innerWidth;let i=f.state.position.top,n=f.state.position.left;if(0===i&&0===n)try{const e=f.view.coordsAtPos(f.state.triggerPos);i=e.bottom+4,n=e.left}catch{}if(i+e.height>t){i=f.view.coordsAtPos(f.state.triggerPos).top-e.height-4,i<0&&(i=8)}n+e.width>o&&(n=o-e.width-8),n<0&&(n=8),i===f.state.position.top&&n===f.state.position.left||x({top:i,left:n})})}),o(()=>{const e=_();if(M){const t=M.querySelector(`[data-index="${e}"]`);t&&t.scrollIntoView({block:"nearest"})}}),re(()=>M,()=>{f.state.active&&xe(f.view)}),i(()=>{const e=e=>{const t=Se.getState(f.view.state);if(!t?.active)return;const o=Oe(t.query,g);if(0!==o.length)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),S(e=>(e+1)%o.length);break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),S(e=>(e-1+o.length)%o.length);break;case"Enter":case"Tab":e.preventDefault(),e.stopPropagation(),T(o[_()]);break;case"Escape":e.preventDefault(),e.stopPropagation(),xe(f.view)}};document.addEventListener("keydown",e,!0),n(()=>{document.removeEventListener("keydown",e,!0)})});const T=async e=>{if(!e)return;const t=Se.getState(f.view.state);if(!t)return;const{triggerPos:o}=t,i=f.view.state.selection.from;if("createSubpage"===e.asyncAction){const e=v(),t=m(),s=f.nodeId;if(!e||!t||!s)return;const r=f.view.state.tr.delete(o,i);f.view.dispatch(r);try{const o=g("slashMenu.untitledSubpage")||"Untitled",i=await e.nodes.page.createPage(s,{title:o});if(!i?.id)return;const n=t.workspace_id,r=t.workspace_name,a=ae(n||"",r,i.id,o),l=ke.link.create({href:a,title:null}),c=pe.text(o,[l]),d=f.view.state.tr.insert(f.view.state.selection.from,c);f.view.dispatch(d),y(),await b(s),await w(i.id),k(a)}catch(n){console.error("Failed to create subpage:",n)}return void f.view.focus()}e.execute(f.view,o,i),f.view.focus()},C=()=>$()??f.state.position;return s(r,{get when(){return f.state.active},get children(){var e=nt();return"function"==typeof M?a(M,e):M=e,l(e,s(r,{get when(){return L().length>0},get fallback(){return e=st(),l(e,()=>g("slashMenu.noResults")),d(()=>u(e,it)),e;var e},get children(){return s(c,{get each(){return L()},children:(e,t)=>{return o=rt(),i=o.firstChild,n=i.nextSibling,o.addEventListener("mouseenter",()=>(e=>{S(e)})(t())),o.$$click=()=>(e=>{T(e)})(e),l(i,()=>e.icon),l(n,()=>g(`slashMenu.${e.labelKey}`)),d(e=>{var s=`${Je} ${t()===_()?et:""}`,r=t(),a=tt,l=ot;return s!==e.e&&u(o,e.e=s),r!==e.t&&p(o,"data-index",e.t=r),a!==e.a&&u(i,e.a=a),l!==e.o&&u(n,e.o=l),e},{e:void 0,t:void 0,a:void 0,o:void 0}),o;var o,i,n}})}})),d(t=>{var o=Ze,i=`${C().top}px`,n=`${C().left}px`,s=(()=>{const e=C();return 0!==e.top||0!==e.left})()?"visible":"hidden";return o!==t.e&&u(e,t.e=o),i!==t.t&&h(e,"top",t.t=i),n!==t.a&&h(e,"left",t.a=n),s!==t.o&&h(e,"visibility",t.o=s),t},{e:void 0,t:void 0,a:void 0,o:void 0}),e}})}g(["click"]);var lt=f('<div data-testid=floating-toolbar><div><button title="Bold (Ctrl+B)">B</button><button title="Italic (Ctrl+I)">I</button><button title="Underline (Ctrl+U)"><u>U</u></button><button title="Strikethrough (Ctrl+Shift+X)"><s>S</s></button><button title="Code (Ctrl+`)">&lt;/></button></div><div><button title="Heading 1">H1</button><button title="Heading 2">H2</button><button title="Heading 3">H3</button><span></span><button title="Bullet List">‚Ä¢</button><button title="Numbered List">1.</button><button title="Task List">‚òê</button><button title=Quote>"</button><button title="Code Block">&lt;/>');function ct(t){let i;const[n,l]=e(!1),[c,p]=e(null);o(k(()=>t.position,()=>{if(!t.position||!i)return l(!1),void p(null);requestAnimationFrame(()=>{if(!i||!t.position)return;const e=i.getBoundingClientRect(),o=t.position.bottom+e.height+8>window.innerHeight;l(o);const n=e.width/2,s=t.editorElement?.getBoundingClientRect(),r=(s?.left??0)+n,a=(s?.right??window.innerWidth)-n,c=t.position.left;p(c<r?r:c>a?a:null)})}));const f=e=>e?`${We} ${je}`:We,g=()=>{if(!t.view)return{isBulletList:!1,isOrderedList:!1,isTaskList:!1};const{state:e}=t.view,{from:o,to:i,$from:n}=e.selection;let s=!1,r=!1,a=!1;for(let t=n.depth;t>0;t--){const e=n.node(t);e.type===ge.bullet_list&&(s=!0),e.type===ge.ordered_list&&(r=!0),e.type===ge.list_item&&null!==e.attrs.checked&&(a=!0)}return s||r||a||e.doc.nodesBetween(o,i,e=>{e.type===ge.bullet_list&&(s=!0),e.type===ge.ordered_list&&(r=!0),e.type===ge.list_item&&null!==e.attrs.checked&&(a=!0)}),a&&(s=!1),{isBulletList:s,isOrderedList:r,isTaskList:a}},m=()=>{t.view&&(U(ke.strong)(t.view.state,t.view.dispatch),t.view.focus())},v=()=>{t.view&&(U(ke.em)(t.view.state,t.view.dispatch),t.view.focus())},w=()=>{t.view&&(U(ke.underline)(t.view.state,t.view.dispatch),t.view.focus())},b=()=>{t.view&&(U(ke.strikethrough)(t.view.state,t.view.dispatch),t.view.focus())},y=()=>{t.view&&(U(ke.code)(t.view.state,t.view.dispatch),t.view.focus())},_=e=>{if(!t.view)return;const{state:o,dispatch:i}=t.view;t.formatState.headingLevel===e?X(ge.paragraph)(o,i):X(ge.heading,{level:e})(o,i),t.view.focus()},S=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view,{from:i,to:n,$from:s}=e.selection;let r=null,a=0;for(let t=s.depth;t>0;t--){const e=s.node(t);if(e.type===ge.bullet_list||e.type===ge.ordered_list){r=e,a=s.before(t);break}}if(r||e.doc.nodesBetween(i,n,(e,t)=>{r||e.type!==ge.bullet_list&&e.type!==ge.ordered_list||(r=e,a=t)}),r){const t=a+r.nodeSize,s=e.selection instanceof Z||i<=1&&n>=e.doc.content.size-1,l=i>=a&&n<=t,c=[];r.forEach(e=>{e.forEach(e=>{c.push(e)})});let d=0;for(const e of c)d+=e.nodeSize;const u=e.tr.replaceWith(a,t,c);if(s)u.setSelection(new Z(u.doc));else if(i!==n&&l)try{const e=a+1,t=a+d-1;u.setSelection(J.create(u.doc,e,t))}catch{u.setSelection(V.near(u.doc.resolve(a)))}else if(i!==n)try{const e=u.mapping.map(i),t=u.mapping.map(n);u.setSelection(J.create(u.doc,e,t))}catch{u.setSelection(V.near(u.doc.resolve(a)))}o(u)}},$=e=>{if(!t.view)return;const{state:o,dispatch:i}=t.view,{from:n,to:s,$from:r}=o.selection;let a=null,l=0;for(let t=r.depth;t>0;t--){const e=r.node(t);if(e.type===ge.bullet_list||e.type===ge.ordered_list){a=e,l=r.before(t);break}}if(a||o.doc.nodesBetween(n,s,(e,t)=>{a||e.type!==ge.bullet_list&&e.type!==ge.ordered_list||(a=e,l=t)}),a){const t=o.selection instanceof Z||n<=1&&s>=o.doc.content.size-1,r=o.tr.setNodeMarkup(l,e);if(e===ge.ordered_list&&r.doc.nodesBetween(l,l+a.nodeSize,(e,t)=>{e.type===ge.list_item&&null!==e.attrs.checked&&r.setNodeMarkup(t,void 0,{checked:null})}),t)r.setSelection(new Z(r.doc));else if(n!==s)try{const e=r.mapping.map(n),t=r.mapping.map(s);r.setSelection(J.create(r.doc,e,t))}catch{}i(r)}},x=e=>{if(!t.view)return;const{state:o,dispatch:i}=t.view,{from:n,to:s}=o.selection,r=o.selection instanceof Z||n<=1&&s>=o.doc.content.size-1;ee(e)(o,e=>{if(r)e.setSelection(new Z(e.doc));else if(n!==s)try{const t=e.mapping.map(n),o=e.mapping.map(s);e.setSelection(J.create(e.doc,t,o))}catch{}i(e)})},M=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view,{from:i,to:n}=e.selection,s=g();if(s.isBulletList)S();else if(s.isOrderedList)$(ge.bullet_list);else if(s.isTaskList){const{$from:t}=e.selection,s=e.selection instanceof Z||i<=1&&n>=e.doc.content.size-1;for(let r=t.depth;r>0;r--){const a=t.node(r);if(a.type===ge.bullet_list){const l=t.before(r);let c=e.tr;if(e.doc.nodesBetween(l,l+a.nodeSize,(e,t)=>{e.type===ge.list_item&&null!==e.attrs.checked&&(c=c.setNodeMarkup(t,void 0,{checked:null}))}),c.docChanged){if(s)c.setSelection(new Z(c.doc));else if(i!==n)try{const e=c.mapping.map(i),t=c.mapping.map(n);c.setSelection(J.create(c.doc,e,t))}catch{}o(c)}break}}}else x(ge.bullet_list);t.view.focus()},L=()=>{if(!t.view)return;const e=g();e.isOrderedList?S():e.isBulletList||e.isTaskList?$(ge.ordered_list):x(ge.ordered_list),t.view.focus()},T=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view,{from:i,to:n,$from:s}=e.selection,r=t=>{for(let e=s.depth;e>0;e--){const o=s.node(e);if(o.type===t)return{start:s.before(e),node:o}}let o=null;return e.doc.nodesBetween(i,n,(e,i)=>{o||e.type!==t||(o={start:i,node:e})}),o},a=e.selection instanceof Z||i<=1&&n>=e.doc.content.size-1,l=e=>{if(a)e.setSelection(new Z(e.doc));else if(i!==n)try{const t=e.mapping.map(i),o=e.mapping.map(n);e.setSelection(J.create(e.doc,t,o))}catch{}},c=g();if(c.isTaskList)S();else if(c.isBulletList){const t=r(ge.bullet_list);if(t){let i=e.tr;e.doc.nodesBetween(t.start,t.start+t.node.nodeSize,(e,t)=>{e.type===ge.list_item&&null===e.attrs.checked&&(i=i.setNodeMarkup(t,void 0,{checked:!1}))}),i.docChanged&&(l(i),o(i))}}else if(c.isOrderedList){const t=r(ge.ordered_list);if(t){let i=e.tr.setNodeMarkup(t.start,ge.bullet_list);i.doc.nodesBetween(t.start,t.start+t.node.nodeSize,(e,t)=>{e.type===ge.list_item&&(i=i.setNodeMarkup(t,void 0,{checked:!1}))}),l(i),o(i)}}else ee(ge.bullet_list)(e,e=>{let t=e;e.doc.descendants((e,o)=>{e.type===ge.list_item&&null===e.attrs.checked&&(t=t.setNodeMarkup(o,void 0,{checked:!1}))}),l(t),o(t)});t.view.focus()},C=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view;t.formatState.isBlockquote?Y(e,o):Q(ge.blockquote)(e,o),t.view.focus()},B=()=>{if(!t.view)return;const{state:e,dispatch:o}=t.view;t.formatState.isCodeBlock?X(ge.paragraph)(e,o):X(ge.code_block)(e,o),t.view.focus()};return s(r,{get when(){return t.position},get children(){var e=lt(),o=e.firstChild,s=o.firstChild,r=s.nextSibling,l=r.nextSibling,p=l.nextSibling,g=p.nextSibling,k=o.nextSibling,S=k.firstChild,$=S.nextSibling,x=$.nextSibling,z=x.nextSibling,I=z.nextSibling,E=I.nextSibling,D=E.nextSibling,N=D.nextSibling,A=N.nextSibling;return"function"==typeof i?a(i,e):i=e,s.$$click=m,r.$$click=v,l.$$click=w,p.$$click=b,g.$$click=y,S.$$click=()=>_(1),$.$$click=()=>_(2),x.$$click=()=>_(3),I.$$click=M,E.$$click=L,D.$$click=T,N.$$click=C,A.$$click=B,d(i=>{var a=`${He} ${n()?Ue:""}`,d=`${n()?t.position?.top:t.position?.bottom}px`,m=`${c()??t.position?.left??0}px`,v=Fe,w=f(t.formatState.isBold),b=f(t.formatState.isItalic),y=f(t.formatState.isUnderline),_=f(t.formatState.isStrikethrough),M=f(t.formatState.isCode),L=Fe,T=f(1===t.formatState.headingLevel),C=f(2===t.formatState.headingLevel),B=f(3===t.formatState.headingLevel),q=Ge,P=f(t.formatState.isBulletList),O=f(t.formatState.isOrderedList),K=f(t.formatState.isTaskList),H=f(t.formatState.isBlockquote),U=f(t.formatState.isCodeBlock);return a!==i.e&&u(e,i.e=a),d!==i.t&&h(e,"top",i.t=d),m!==i.a&&h(e,"left",i.a=m),v!==i.o&&u(o,i.o=v),w!==i.i&&u(s,i.i=w),b!==i.n&&u(r,i.n=b),y!==i.s&&u(l,i.s=y),_!==i.h&&u(p,i.h=_),M!==i.r&&u(g,i.r=M),L!==i.d&&u(k,i.d=L),T!==i.l&&u(S,i.l=T),C!==i.u&&u($,i.u=C),B!==i.c&&u(x,i.c=B),q!==i.w&&u(z,i.w=q),P!==i.m&&u(I,i.m=P),O!==i.f&&u(E,i.f=O),K!==i.y&&u(D,i.y=K),H!==i.g&&u(N,i.g=H),U!==i.p&&u(A,i.p=U),i},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0,w:void 0,m:void 0,f:void 0,y:void 0,g:void 0,p:void 0}),e}})}g(["click"]);var dt=f('<div><div data-testid=wysiwyg-editor></div><textarea data-testid=markdown-editor></textarea><div><button title="Visual mode (Ctrl+Shift+M)"data-testid=editor-mode-visual>Visual</button><button title="Markdown mode (Ctrl+Shift+M)"data-testid=editor-mode-markdown>MD');function ut(t){const{t:c}=oe(),[h,f]=e("wysiwyg"),[g,w]=e(m(()=>t.content)),[b,y]=e(),[_,S]=e({active:!1,query:"",triggerPos:0,position:{top:0,left:0}}),[$,x]=e(),M=(L=S,new E({key:Se,state:{init:()=>({...$e}),apply(e,t,o,i){const n=e.getMeta(Se);if(n?.close){if(t.active){const e={...$e};return setTimeout(()=>L(e),0),e}return t}if(!e.docChanged&&!e.selectionSet)return t;const{selection:s}=i,{$from:r}=s;if(!s.empty){if(t.active){const e={...$e};return setTimeout(()=>L(e),0),e}return t}const a=r.start(r.depth),l=i.doc.textBetween(a,r.pos,"",""),c=l.match(/(^|\s)\/([^\s]*)$/);if(c){const e=c[2]||"",o={active:!0,query:e,triggerPos:a+(l.length-c[0].length+(c[1]?1:0)),position:t.position};return t.active&&e!==t.query&&setTimeout(()=>L(o),0),o}if(t.active){const e={...$e};return setTimeout(()=>L(e),0),e}return t}},view:e=>({update(e){const t=Se.getState(e.state);if(t?.active)try{const o=e.coordsAtPos(t.triggerPos),i=o.bottom+4,n=o.left,s=i>0||n>0?{top:i,left:n}:t.position,r={...t,position:s};L(r)}catch{L(t)}}}),props:{handleKeyDown(e,t){const o=Se.getState(e.state);return!!o?.active&&("ArrowDown"===t.key||"ArrowUp"===t.key||"Enter"===t.key||"Tab"===t.key||"Escape"===t.key&&(xe(e),!0))}}}));var L;const T=new E({key:Be,state:{init:()=>({decorations:N.empty,linkedNodeTitles:{},wsId:void 0}),apply(e,t,o,i){const n=e.getMeta(Be);if(n){const e=n.linkedNodeTitles??t.linkedNodeTitles,o=n.wsId??t.wsId;return{decorations:ze(i.doc,e,o),linkedNodeTitles:e,wsId:o}}return e.docChanged?{...t,decorations:ze(i.doc,t.linkedNodeTitles,t.wsId)}:{...t,decorations:t.decorations.map(e.mapping,e.doc)}}},props:{decorations:e=>Be.getState(e)?.decorations??N.empty}}),C=(B={onFileDrop:async(o,i)=>{const n=b();if(!(n&&t.wsId&&t.nodeId&&t.getToken))return;const{uploadFile:s,error:r}=function(t){const[o,i]=e(!1),[n,s]=e(null);return{uploadFile:async e=>{if(s(null),e.size>10485760){const t=`File too large: ${e.name} (max 10MB)`;return s(t),console.error(t),null}if(!Ee.has(e.type)){const t=`Unsupported file type: ${e.type}`;return s(t),console.error(t),null}const o=t.getToken();if(!o){const e="Not authenticated";return s(e),console.error(e),null}i(!0);try{const i=new FormData;i.append("file",e);const n=await fetch(`/api/workspaces/${t.wsId}/nodes/${t.nodeId}/assets`,{method:"POST",headers:{Authorization:`Bearer ${o}`},body:i});if(!n.ok){const e=await n.text();throw new Error(`Upload failed: ${n.status} ${e}`)}const s=await n.json();return{name:s.name,mimeType:s.mime_type,url:s.url}}catch(n){const e=n instanceof Error?n.message:String(n);return s(e),console.error("Asset upload failed:",n),null}finally{i(!1)}},uploading:o,error:n}}({wsId:t.wsId,nodeId:t.nodeId,getToken:t.getToken});for(const e of o){const o=await s(e);if(o){const e=De(o.mimeType);let s=n.state.tr;if(e){const e=pe.nodes.image;if(e){const t=e.create({src:o.url,alt:o.name,title:null});s=s.insert(i,t)}}else{const e=pe.marks.link;if(e){const t=e.create({href:o.url,title:null}),n=pe.text(o.name,[t]);s=s.insert(i,n)}}n.dispatch(s),t.onAssetUploaded?.()}else{const e=r();e&&t.onError?.(e)}}}},new E({key:Me,state:{init:()=>({isDragging:!1}),apply(e,t){const o=e.getMeta(Me);return void 0!==o?{isDragging:o.isDragging}:t}},props:{attributes(e){const t=Me.getState(e);return t?.isDragging?{class:"drop-target-active"}:{}},handleDOMEvents:{dragenter:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),Le(e,!0),!1),dragover:(e,t)=>!!t.dataTransfer?.types.includes("Files")&&(t.preventDefault(),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"),!1),dragleave(e,t){const o=t.relatedTarget,i=e.dom;return o&&i.contains(o)||Le(e,!1),!1},drop(e,t){Le(e,!1);const o=t.dataTransfer?.files;if(!o||0===o.length)return!1;const i=[];for(const s of o)Te(s.type)&&i.push(s);if(0===i.length)return!1;t.preventDefault();const n=e.posAtCoords({left:t.clientX,top:t.clientY});return n?(B.onFileDrop(i,n.pos),!0):(B.onFileDrop(i,e.state.doc.content.size),!0)}}}}));var B;let z=m(()=>t.nodeId),I=m(()=>t.content),D=m(()=>t.linkedNodeTitles);const[A,q]=e({isBold:!1,isItalic:!1,isUnderline:!1,isStrikethrough:!1,isCode:!1,headingLevel:null,isBulletList:!1,isOrderedList:!1,isTaskList:!1,isBlockquote:!1,isCodeBlock:!1}),[P,O]=e(null),K=e=>{let o=le(e,t.assetUrls||{});return t.wsId&&t.linkedNodeTitles&&Object.keys(t.linkedNodeTitles).length>0&&(o=ce(o,t.linkedNodeTitles,t.wsId)),ve.parse(o)},H=e=>{const o=we.serialize(e);return de(o,t.assetUrls||{})},U=e=>{const{state:t}=e,{from:o,$from:i,to:n,empty:s}=t.selection;if(s||"markdown"===h())O(null);else try{const t=e.coordsAtPos(o),i=e.coordsAtPos(n),s=Math.abs(t.top-i.top)<20;let r=t.left;r=s?(t.left+i.right)/2:t.left+40,O({top:t.top,bottom:i.bottom,left:r})}catch{O(null)}const r=s?t.storedMarks||i.marks():[],a=void 0!==ke.strong.isInSet(r)||t.doc.rangeHasMark(o,n,ke.strong),l=void 0!==ke.em.isInSet(r)||t.doc.rangeHasMark(o,n,ke.em),c=void 0!==ke.underline.isInSet(r)||t.doc.rangeHasMark(o,n,ke.underline),d=void 0!==ke.strikethrough.isInSet(r)||t.doc.rangeHasMark(o,n,ke.strikethrough),u=void 0!==ke.code.isInSet(r)||t.doc.rangeHasMark(o,n,ke.code),p=i.node(i.depth),f=p.type===ge.heading?p.attrs.level:null,g=p.type===ge.code_block;let k=!1,m=!1,v=!1,w=!1;for(let h=i.depth;h>0;h--){const e=i.node(h);e.type===ge.bullet_list&&(k=!0),e.type===ge.ordered_list&&(m=!0),e.type===ge.list_item&&null!==e.attrs.checked&&(v=!0),e.type===ge.blockquote&&(w=!0)}k||m||v||t.doc.nodesBetween(o,n,e=>{e.type===ge.bullet_list&&(k=!0),e.type===ge.ordered_list&&(m=!0),e.type===ge.list_item&&null!==e.attrs.checked&&(v=!0),e.type===ge.blockquote&&(w=!0)}),v&&(k=!1),q({isBold:a,isItalic:l,isUnderline:c,isStrikethrough:d,isCode:u,headingLevel:f,isBulletList:k,isOrderedList:m,isTaskList:v,isBlockquote:w,isCodeBlock:g})};i(()=>{const e=$();if(!e)return;const o=K(t.content);if(!o)return;const i=_e(o,[M,C,T]),s=new te(e,{state:i,editable:()=>!t.readOnly,dispatchTransaction(e){const o=s.state.apply(e);if(s.updateState(o),e.docChanged){const e=H(o.doc);w(e),I=e,t.onChange(e)}U(s)},handleDOMEvents:{click:(e,o)=>{const i=o.target.closest("a");if(!i)return!1;const n=i.getAttribute("href");if(!n)return!1;const s=n.match(Ce);return s&&s[2]&&t.onNavigateToNode?(o.preventDefault(),t.onNavigateToNode(s[2]),!0):!(!n.startsWith("http://")&&!n.startsWith("https://"))&&(o.preventDefault(),window.open(n,"_blank","noopener,noreferrer"),!0)}}}),r=e.querySelector(".ProseMirror");r&&(r.pmView=s),y(s),U(s),Ie(s,t.linkedNodeTitles||{},t.wsId);const a=()=>U(s),l=e.closest('[class*="prosemirrorEditor"]')||e;l.addEventListener("scroll",a,{passive:!0}),window.addEventListener("scroll",a,{passive:!0}),n(()=>{s.destroy(),l.removeEventListener("scroll",a),window.removeEventListener("scroll",a)})}),o(k(()=>[t.nodeId,t.content,t.linkedNodeTitles],([e,o,i])=>{const n=e!==z,s=o!==I;if(n||s||i!==D){z=e,I=o,D=i,(n||s)&&(w(o),f("wysiwyg"));const r=b();if(r){const e=K(o);if(e){const o=_e(e,[M,C,T]);r.updateState(o),Ie(r,i||{},t.wsId)}}}},{defer:!0}));const F=()=>{const e=b();if(e){const o=K(g());if(o){const i=_e(o,[M,C,T]);e.updateState(i),U(e),Ie(e,t.linkedNodeTitles||{},t.wsId)}}f("wysiwyg")},W=()=>{const e=b();if(e){const t=H(e.state.doc);w(t)}f("markdown")},j=e=>{e.ctrlKey&&e.shiftKey&&"m"===e.key.toLowerCase()&&(e.preventDefault(),"wysiwyg"===h()?W():F())};i(()=>{document.addEventListener("keydown",j)}),n(()=>{document.removeEventListener("keydown",j)});const G=v(()=>"wysiwyg"===h()?Xe:`${Xe} ${Ye}`),R=v(()=>"markdown"===h()?Qe:`${Qe} ${Ye}`);return V=dt(),X=V.firstChild,Q=X.nextSibling,Y=Q.nextSibling,Z=Y.firstChild,J=Z.nextSibling,l(V,s(ct,{get formatState(){return A()},get view(){return b()},get position(){return P()},get editorElement(){return $()}}),X),a(x,X),Q.$$input=e=>{return o=e.target.value,w(o),I=o,void t.onChange(o);var o},Z.$$click=F,J.$$click=W,l(V,s(r,{get when(){return b()},children:e=>s(at,{get view(){return e()},get state(){return _()},get nodeId(){return t.nodeId}})}),null),d(e=>{var o=Ke,i=G(),n=R(),s=t.placeholder||c("editor.contentPlaceholder")||"Write markdown...",r=t.readOnly,a=Re,l="wysiwyg"===h()?Ve:void 0,d="markdown"===h()?Ve:void 0;return o!==e.e&&u(V,e.e=o),i!==e.t&&u(X,e.t=i),n!==e.a&&u(Q,e.a=n),s!==e.o&&p(Q,"placeholder",e.o=s),r!==e.i&&(Q.readOnly=e.i=r),a!==e.n&&u(Y,e.n=a),l!==e.s&&u(Z,e.s=l),d!==e.h&&u(J,e.h=d),e},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),d(()=>Q.value=g()),V;var V,X,Q,Y,Z,J}g(["input","click"]);export{ut as default};
